<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Get a Quote | No Mow Worries Lawn Care</title>
    <link rel="icon" type="image/png" href="https://nomowworriesco.com/wp-content/uploads/2023/09/Untitled-design-2024-02-27T142837.736-150x150.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://nomowworriesco.com/wp-content/uploads/2023/09/Untitled-design-2024-02-27T142837.736.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://nomowworriesco.com/wp-content/uploads/2023/09/Untitled-design-2024-02-27T142837.736.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --green: #16a34a;
            --green-light: #dcfce7;
            --green-hover: #bbf7d0;
            --green-dark: #15803d;
            --bg: #ffffff;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text: #111827;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --radius: 16px;
            --radius-sm: 10px;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
        }
        
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 32px 120px;
        }
        
        /* Embed mode - let content grow naturally, iframe resizes to match */
        .embed-mode .container {
            max-height: none;
            overflow: visible;
            padding-bottom: 40px;
        }
        
        /* Prevent container scrollbars when service dropdowns are open */
        .embed-mode .container:has(.service-dropdown.show) {
            overflow: visible;
        }
        
        /* Class-based fallback for dropdown open state */
        .embed-mode .container.dropdown-open {
            overflow: visible;
        }
        
        .container.dropdown-open {
            overflow: visible !important;
        }
        
        .embed-mode .form-content {
            max-height: none;
        }
        
        /* Remove any possible scrollbar issues */
        html, body {
            overflow-x: hidden;
        }
        
        /* Mobile: ensure content flows naturally without nested scroll containers */
        @media (max-width: 768px) {
            html, body {
                height: auto;
                min-height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .container {
                height: auto;
                min-height: auto;
                overflow: visible;
            }
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .brand-logo {
            margin-bottom: 16px;
        }
        
        .nmw-logo {
            max-width: 200px;
            height: auto;
        }
        
        @media (max-width: 480px) {
            .nmw-logo {
                max-width: 160px;
            }
        }
        
        .logo {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--green);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .logo-icon svg { width: 26px; height: 26px; }
        
        .logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--green);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text);
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 15px;
        }
        
        /* Progress Steps */
        .steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 32px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .step.active { color: var(--green); }
        .step.done { color: var(--green); }
        
        .step-num {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
        }
        
        .step.active .step-num { 
            background: var(--green); 
            color: white; 
        }
        .step.done .step-num { 
            background: var(--green-light); 
            color: var(--green); 
        }
        
        .step-line {
            width: 40px;
            height: 2px;
            background: #e5e7eb;
        }
        
        .step.done + .step-line,
        .step.active + .step-line { background: var(--green-light); }
        
        /* Card */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 24px 28px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text);
            text-align: center;
            letter-spacing: -0.3px;
        }
        
        .card-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Form Fields */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-row.single { grid-template-columns: 1fr; }
        
        .field label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .field input,
        .field select,
        .field textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            font-family: inherit;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            color: var(--text);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        
        .field input::placeholder { color: var(--text-light); }
        
        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 3px var(--green-light);
        }
        
        /* Package Quick-Select */
        .packages-wrap {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: stretch;
        }
        
        .package-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 22px 24px 24px;
            width: 260px;
            min-height: 320px;
            flex-shrink: 0;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        /* Hover only on devices that support true hover (desktop) */
        @media (hover: hover) and (pointer: fine) {
            .package-btn:hover {
                border-color: var(--green);
                background: linear-gradient(180deg, rgba(34, 197, 94, 0.04) 0%, transparent 100%);
                transform: translateY(-2px);
            }
        }
        
        /* Active state for touch feedback on mobile */
        .package-btn:active {
            border-color: var(--green);
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.04) 0%, transparent 100%);
        }
        
        .package-btn.selected {
            border-color: var(--green);
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.02) 100%);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }
        
        /* Package name and tagline */
        .package-name {
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }
        
        .package-tagline {
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: block;
        }
        
        /* Package description bullet list - SERVICES */
        .package-desc-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            font-size: 12px;
            color: var(--text);
            line-height: 1.7;
            width: 100%;
        }
        
        .package-desc-list li {
            position: relative;
            padding-left: 18px;
        }
        
        .package-desc-list li::before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--green);
            font-weight: 600;
        }
        
        /* Package perks section - differentiator from services */
        .package-perks {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
            width: 100%;
        }
        
        .package-perks-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 6px;
            display: block;
        }
        
        .package-perks-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .package-perks-list li {
            position: relative;
            padding-left: 16px;
        }
        
        .package-perks-list li::before {
            content: "+";
            position: absolute;
            left: 0;
            color: var(--green);
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Service pill highlight when package is hovered */
        .service-pill.package-highlight {
            border-color: var(--green) !important;
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.02) 100%) !important;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12) !important;
        }
        
        /* Premium package customize hint animation */
        @keyframes premiumHintPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(251, 191, 36, 0); }
        }
        
        .service-pill.premium-customize-hint {
            animation: premiumHintPulse 1s ease-in-out 3;
            border-color: #fbbf24 !important;
        }
        
        /* package-name and package-tagline styles moved to package section above */
        
        .package-desc {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.5;
            max-width: 200px;
        }
        
        .package-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-radius: 20px;
            white-space: nowrap;
        }
        
        .package-badge.popular {
            background: linear-gradient(135deg, var(--green) 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }
        
        .package-badge.value {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(30, 58, 95, 0.4);
        }
        
        .package-badge svg {
            width: 12px;
            height: 12px;
        }
        
        .package-badge.value svg {
            display: none;
        }
        
        .services-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 24px 0 20px;
            color: var(--green);
            font-size: 14px;
            font-weight: 500;
        }
        
        .services-divider span {
            /* Clean text - no oval/pill */
        }
        
        .services-divider::before,
        .services-divider::after {
            content: '';
            flex: 1;
            max-width: 80px;
            height: 1px;
            background: var(--border);
            margin: 0 16px;
        }
        
        /* Service Selection - Primary buttons (smaller than package cards) */
        .services-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
            overflow: visible;
        }
        
        /* Prevent scrollbars when dropdowns are open */
        .services-wrap:has(.service-dropdown.show) {
            overflow: visible;
        }
        
        /* Service with dropdown container */
        .service-with-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .service-pill {
            position: relative;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 14px;
            min-height: 38px;
            min-width: 120px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            text-align: center;
        }
        
        /* Hover only on devices that support true hover (desktop) */
        @media (hover: hover) and (pointer: fine) {
            .service-pill:hover {
                background: var(--green-hover);
                border-color: var(--green-hover);
            }
        }
        
        /* Active state for touch feedback */
        .service-pill:active {
            background: var(--green-hover);
            border-color: var(--green-hover);
        }
        
        .service-pill.selected {
            background: var(--green-light);
            border-color: var(--green);
            color: var(--green-dark);
        }
        
        /* Mobile: prevent sticky hover states and ensure clean touch behavior */
        @media (hover: none) and (pointer: coarse) {
            .service-pill {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* Force immediate visual reset on deselect */
            .service-pill:not(.selected):not(.package-highlight) {
                background: var(--card-bg) !important;
                border-color: var(--border) !important;
                color: var(--text) !important;
                box-shadow: none !important;
            }
            
            /* Only apply light green when actually selected */
            .service-pill.selected {
                background: var(--green-light) !important;
                border-color: var(--green) !important;
                color: var(--green-dark) !important;
            }
            
            /* Package buttons - prevent sticky hover */
            .package-btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* Reset package buttons that aren't selected */
            .package-btn:not(.selected) {
                border-color: var(--border) !important;
                background: var(--card-bg) !important;
                transform: none !important;
            }
        }
        
        /* Always-visible description under pill */
        .pill-desc {
            display: block;
            font-size: 11px;
            font-weight: 400;
            color: var(--text-muted);
            margin-top: 2px;
            text-align: center;
        }
        
        .service-pill.selected .pill-desc {
            color: var(--green-dark);
            opacity: 0.8;
        }
        
        /* Sub-label inside pill (shows when selected) */
        .pill-sublabel {
            display: none;
            font-size: 10px;
            font-weight: 400;
            color: var(--green-dark);
            opacity: 0.8;
            margin-top: 2px;
            text-align: center;
        }
        
        .service-pill.selected .pill-sublabel.show {
            display: block;
        }
        
        /* When fertilization is included via Weed Control + Fertilizer */
        .service-pill.included-via-weedman {
            opacity: 0.85;
            pointer-events: none;
        }
        .service-pill.included-via-weedman .pill-sublabel {
            color: #16a34a;
            font-weight: 500;
        }
        
        /* Hover tooltip for service pills */
        .pill-tooltip {
            position: absolute;
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 12px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.4;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .pill-tooltip::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1f2937;
        }
        
        /* Only show tooltip on true hover (desktop) */
        @media (hover: hover) and (pointer: fine) {
            .service-pill:hover .pill-tooltip {
                opacity: 1;
                visibility: visible;
            }
        }
        
        /* Service dropdown (shared by mowing, fertilization, mulch, bush trimming) */
        .service-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            min-width: 220px;
            overflow: hidden;
        }
        
        .service-dropdown.show { display: block; }
        
        .dropdown-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            font-family: inherit;
            text-align: left;
            background: white;
            border: none;
            cursor: pointer;
            transition: background 0.15s;
            color: var(--text);
        }
        
        /* Hover only on devices that support true hover (desktop) */
        @media (hover: hover) and (pointer: fine) {
            .dropdown-option:hover {
                background: var(--green-light);
            }
        }
        
        /* Active state for touch feedback */
        .dropdown-option:active {
            background: var(--green-light);
        }
        
        .dropdown-option.selected {
            background: var(--green-light);
            color: var(--green-dark);
            font-weight: 500;
        }
        
        .dropdown-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: var(--text-muted);
        }
        
        /* Only apply hover to disabled on desktop */
        @media (hover: hover) and (pointer: fine) {
            .dropdown-option.disabled:hover {
                background: white;
            }
        }
        
        /* Mobile: prevent sticky hover states on dropdown options */
        @media (hover: none) and (pointer: coarse) {
            .dropdown-option {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* Reset non-selected options to white */
            .dropdown-option:not(.selected):not(:active) {
                background: white !important;
            }
        }
        
        .dropdown-option-content {
            flex: 1;
        }
        
        .dropdown-note {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        /* Deselect X icon in dropdown */
        .dropdown-deselect {
            display: none;
            width: 18px;
            height: 18px;
            margin-left: 8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            line-height: 18px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .dropdown-option.selected .dropdown-deselect {
            display: block;
        }
        
        /* Info note inside dropdown */
        .dropdown-info {
            padding: 10px 14px;
            font-size: 10px;
            color: var(--text-muted);
            background: #f9fafb;
            border-top: 1px solid var(--border);
            line-height: 1.4;
        }
        
        /* Weed Man Partner Services Multi-Select Dropdown */
        .weedman-dropdown {
            min-width: 280px;
            padding: 0;
            border-radius: 12px;
            overflow: visible;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        }
        
        .weedman-header {
            padding: 12px 14px;
            background: linear-gradient(135deg, #f8faf8 0%, #f0f4f0 100%);
            border-bottom: 1px solid #e8ece8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            overflow: visible;
            position: relative;
            z-index: 10;
        }
        
        /* Fix tooltip clipping inside weedman dropdown */
        .weedman-partner-badge {
            overflow: visible;
        }
        
        .weedman-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .weedman-header-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .weedman-header-icon svg {
            width: 20px;
            height: 20px;
        }
        
        .weedman-partner-badge {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .weedman-partner-badge .partner-title {
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            letter-spacing: 0;
            line-height: 1.3;
        }
        
        .weedman-partner-badge .partner-link {
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            line-height: 1.3;
        }
        
        .weedman-partner-badge .partner-link a {
            color: #16a34a;
            text-decoration: underline;
            text-underline-offset: 2px;
            font-weight: 600;
        }
        
        .weedman-partner-badge .partner-link a:hover {
            color: #15803d;
        }
        
        .weedman-options {
            padding: 6px 0;
            max-height: 320px;
            overflow-y: auto;
        }
        
        .weedman-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin: 0;
            background: white;
        }
        
        .weedman-option:last-of-type {
            border-bottom: none;
        }
        
        @media (hover: hover) and (pointer: fine) {
            .weedman-option:hover {
                background: #f8faf8;
            }
        }
        
        .weedman-option:active {
            background: #f0f4f0;
        }
        
        .weedman-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--green);
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 1px;
            border-radius: 4px;
        }
        
        .weedman-option-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .weedman-option-name {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            line-height: 1.3;
        }
        
        .weedman-option-note {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.3;
        }
        
        .weedman-done-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .weedman-done-btn svg {
            width: 12px;
            height: 12px;
            fill: white;
        }
        
        .weedman-done-btn:hover {
            background: var(--green-dark);
        }
        
        .weedman-done-btn:active {
            transform: scale(0.98);
        }
        
        /* Legacy support: mowing-dropdown class */
        .mowing-dropdown { display: none; }
        .mowing-dropdown.show { display: block; }
        
        /* Partner/warning notes */
        .info-note {
            display: none;
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--warning-bg);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--warning-text);
        }
        
        .info-note.show { display: block; }
        
        .info-note.danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Property Questions */
        .question-section {
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
        }
        
        .question-section:last-child { border-bottom: none; }
        
        .question-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .question-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
        }
        
        .toggle-group {
            display: flex;
            gap: 4px;
        }
        
        .toggle-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            background: #f3f4f6;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-muted);
        }
        
        .toggle-btn:first-child { border-radius: 8px 0 0 8px; }
        .toggle-btn:last-child { border-radius: 0 8px 8px 0; }
        
        .toggle-btn.selected {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }
        
        /* Overgrown toggle tooltip */
        .overgrown-toggle {
            position: relative;
        }
        
        .toggle-with-tooltip {
            position: relative;
        }
        
        .toggle-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            right: 0;
            width: 280px;
            padding: 12px 14px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            border-radius: 10px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toggle-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 20px;
            border: 8px solid transparent;
            border-top-color: #1f2937;
        }
        
        .toggle-with-tooltip:hover .toggle-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Conditional Sections - Property Details & Notes hidden until service selected */
        .conditional-section {
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .conditional-section.visible {
            display: block !important;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Conditional Fields - cleaned up, no green bar */
        .conditional-field {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: var(--radius-sm);
        }
        
        .conditional-field.show { display: block; }
        
        /* Disclaimer Card */
        .disclaimer-card {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            margin-bottom: 24px;
        }
        
        .disclaimer-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
        }
        
        .disclaimer-header svg {
            color: #f59e0b;
        }
        
        .disclaimer-text {
            font-size: 14px;
            color: #78350f;
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .disclaimer-list {
            list-style: disc;
            padding-left: 20px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #78350f;
        }
        
        .disclaimer-list li {
            margin-bottom: 6px;
        }
        
        .disclaimer-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #78350f;
        }
        
        .disclaimer-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: #16a34a;
            cursor: pointer;
        }
        
        .disclaimer-checkbox span {
            flex: 1;
        }
        
        .conditional-field label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .inline-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .inline-input:last-child { margin-bottom: 0; }
        
        .inline-input input {
            width: 100px;
            padding: 10px 14px;
            font-size: 15px;
            font-family: inherit;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
        }
        
        .inline-input input.wider {
            width: 160px;
            text-align: left;
        }
        
        .inline-input span {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .sub-question {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .sub-question-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .sub-question-text {
            font-size: 14px;
            color: var(--text);
        }
        
        /* Nested conditional within conditional */
        .nested-field {
            display: none;
            margin-top: 12px;
        }
        
        .nested-field.show { display: block; }
        
        /* Gate Width Slider */
        .gate-slider-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .gate-slider-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .gate-slider-wrapper {
            flex: 1;
            position: relative;
        }
        
        .gate-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, 
                #dc2626 0%, 
                #dc2626 30%, 
                #22c55e 34%, 
                #22c55e 100%);
            outline: none;
            cursor: pointer;
            transition: opacity 0.15s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
        }
        
        .gate-slider:hover {
            opacity: 0.95;
        }
        
        .gate-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .gate-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        }
        
        .gate-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.15);
        }
        
        .gate-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .gate-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }
        
        .gate-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-top: 8px;
            padding: 0 4px;
        }
        
        .gate-slider-labels span:nth-child(2) {
            color: #22c55e;
            font-weight: 700;
        }
        
        .gate-input-group {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 110px;
        }
        
        .gate-input-group input {
            width: 70px;
            padding: 10px 12px;
            font-size: 16px;
            font-family: inherit;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
            transition: border-color 0.15s;
        }
        
        .gate-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .gate-input-group span {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .gate-slider-hint {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: -4px;
        }
        
        /* Live value display next to slider */
        .gate-live-value {
            display: none;
            min-width: 60px;
            padding: 10px 14px;
            background: linear-gradient(135deg, var(--primary) 0%, #16a34a 100%);
            color: white;
            font-size: 18px;
            font-weight: 700;
            border-radius: 10px;
            text-align: center;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }
        
        /* Mobile optimizations for slider */
        @media (max-width: 480px) {
            .gate-slider::-webkit-slider-thumb {
                width: 32px;
                height: 32px;
            }
            
            .gate-slider::-moz-range-thumb {
                width: 32px;
                height: 32px;
            }
            
            .gate-slider-row {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 12px;
            }
            
            .gate-slider-wrapper {
                flex: 1;
                min-width: 0;
                order: 1;
            }
            
            /* Hide the full input group on mobile, show compact live value on RIGHT */
            .gate-input-group {
                display: none;
            }
            
            .gate-live-value {
                display: flex;
                align-items: center;
                justify-content: center;
                order: 2;
                min-width: 65px;
                height: 44px;
            }
            
            .gate-slider-labels {
                font-size: 11px;
                font-weight: 500;
            }
            
            .gate-slider-hint {
                display: block;
                font-size: 11px;
                margin-top: 8px;
            }
        }

        /* Warning banners inside conditionals */
        .inline-warning {
            display: none;
            margin-top: 12px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            font-size: 13px;
            color: #92400e;
            border-left: 4px solid #f59e0b;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
        }
        
        .inline-warning.show { 
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .inline-warning.danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #991b1b;
            border-left-color: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        }
        
        .inline-success {
            display: none;
            margin-top: 12px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 12px;
            font-size: 13px;
            color: #065f46;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }
        
        .inline-success.show { 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Dog confirmation checkbox */
        .dog-confirm {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 12px;
            padding: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }
        
        .dog-confirm input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--green);
            cursor: pointer;
        }
        
        .dog-confirm-text {
            font-size: 13px;
            color: var(--text);
            line-height: 1.4;
        }
        
        /* Photo Upload */
        .photo-section {
            display: none;
        }
        
        .photo-section.show { display: block; }
        
        .photo-header {
            position: relative;
            margin-bottom: 6px;
        }
        
        .photo-header .card-title {
            margin-bottom: 0;
        }
        
        .photo-header .photo-toggle {
            position: absolute;
            top: 0;
            right: 0;
        }
        
        .photo-toggle {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--green);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .photo-toggle.off {
            background: #d1d5db;
        }
        
        .photo-toggle-knob {
            position: absolute;
            top: 2px;
            left: 26px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .photo-toggle.off .photo-toggle-knob {
            left: 2px;
        }
        
        .photo-content {
            display: block;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 20px 16px;
            max-height: none;
            overflow: visible;
        }
        
        .photo-content.hidden {
            display: none;
        }
        
        .photo-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }
        
        .photo-count.at-limit {
            color: #ef4444;
            font-weight: 500;
        }
        
        /* Photo Skip Modal - Inline version */
        .photo-modal-overlay {
            display: none;
            margin-top: 16px;
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .photo-modal-overlay.show {
            display: block;
        }
        
        .photo-modal {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: var(--radius);
            width: 100%;
            padding: 20px;
        }
        
        .photo-modal-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #92400e;
        }
        
        .photo-modal-warning {
            font-size: 14px;
            color: #78350f;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        
        .photo-modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .photo-modal-btn {
            flex: 1;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .photo-modal-btn.primary {
            background: var(--green);
            color: white;
            border: none;
        }
        
        .photo-modal-btn.primary:hover {
            background: var(--green-dark);
        }
        
        .photo-modal-btn.secondary {
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .photo-modal-btn.secondary:hover {
            background: #f9fafb;
        }
        
        .upload-area {
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }
        
        .upload-area:hover {
            background: var(--green-light);
        }
        
        .upload-area.dragover {
            background: var(--green-light);
        }
        
        .upload-icon {
            width: 40px;
            height: 40px;
            background: var(--green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
        }
        
        .upload-icon svg {
            width: 20px;
            height: 20px;
            color: var(--green);
        }
        
        .upload-text {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .upload-hint {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            max-height: none;
            overflow: visible;
        }
        
        .photo-preview:empty { display: none; }
        
        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 26px;
            height: 26px;
            background: rgba(0,0,0,0.6);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        /* Notes */
        .notes-section textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        
        /* Map Section */
        .map-container {
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .map-wrapper {
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 400px;
            background: #e5e7eb;
        }
        
        /* Taller map on desktop */
        @media (min-width: 768px) {
            #map {
                height: 550px;
            }
        }
        
        .point-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.75);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            backdrop-filter: blur(8px);
            z-index: 10;
        }
        .point-badge.ready { background: var(--green); }
        
        .map-instructions {
            padding: 10px 14px;
            background: var(--card-bg);
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .map-instructions strong { color: var(--text); }
        
        /* Mobile hint only shows on touch devices */
        .mobile-hint { display: none; }
        @media (hover: none) and (pointer: coarse) {
            .mobile-hint { display: inline; }
        }
        
        .map-toolbar {
            display: flex;
            gap: 6px;
            padding: 10px 14px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .map-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            background: #f3f4f6;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .map-btn:hover { border-color: var(--green); }
        .map-btn.active { background: var(--green); border-color: var(--green); color: white; }
        .map-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .map-btn svg { width: 12px; height: 12px; }
        
        .map-btn.finish-btn { background: var(--green); border-color: var(--green); color: white; }
        .map-btn.finish-btn:hover { background: var(--green-dark); border-color: var(--green-dark); }
        
        .map-btn.danger { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
        .map-btn.danger:hover { background: #fee2e2; }
        
        .map-result {
            padding: 18px;
            background: var(--green-light);
            border-top: 1px solid var(--border);
            text-align: center;
        }
        
        .map-result-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--green-dark);
            margin-bottom: 4px;
        }
        
        .map-result-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--green-dark);
            margin-bottom: 12px;
        }
        
        .area-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 12px;
        }
        
        .area-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
        }
        
        .area-chip-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .area-chip-name { color: var(--text-muted); }
        .area-chip-sqft { font-weight: 600; color: var(--text); }
        
        .area-chip-remove {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 2px 4px;
            margin-left: 2px;
            line-height: 1;
            font-size: 16px;
        }
        .area-chip-remove:hover { color: #ef4444; }
        
        /* Help Menu */
        .help-menu {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: var(--radius-sm);
        }
        .help-menu-content {
            background: white;
            border-radius: var(--radius-sm);
            padding: 20px;
            max-width: 320px;
            margin: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .help-menu-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }
        .help-menu-list {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.7;
        }
        .help-menu-list li {
            margin-bottom: 6px;
        }
        .help-menu-list strong {
            color: var(--text);
        }
        .help-menu-close {
            width: 100%;
            margin-top: 16px;
            padding: 10px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .help-menu-close:hover {
            background: var(--green-dark);
        }
        
        /* Measurement Importance Notice - Clean professional design */
        .measurement-notice {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        
        .measurement-notice-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .measurement-notice-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--green-light) 0%, #bbf7d0 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .measurement-notice-icon svg {
            width: 24px;
            height: 24px;
            color: var(--green);
        }
        
        .measurement-notice-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.3px;
        }
        
        .measurement-notice-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .measurement-notice-body {
            font-size: 14px;
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .measurement-services {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }
        
        .measurement-service-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }
        
        .measurement-service-tag svg {
            width: 14px;
            height: 14px;
            color: var(--green);
        }
        
        .measurement-notice-footer {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 14px 16px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 3px solid var(--green);
        }
        
        .measurement-notice-footer-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            color: var(--green);
        }
        
        .measurement-notice-footer-text {
            font-size: 13px;
            color: #475569;
            line-height: 1.5;
        }
        
        .measurement-notice-footer-text strong {
            color: var(--text);
            font-weight: 600;
        }
        
        /* Mulch Indicator - Clean notice (no animation) */
        .mulch-indicator {
            padding: 12px 16px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #92400e;
            background: #fffbeb;
            border-radius: 8px;
            border: 1px solid #fcd34d;
        }
        
        .mulch-indicator-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d97706;
            flex-shrink: 0;
        }
        
        .mulch-indicator-icon svg {
            width: 18px;
            height: 18px;
        }
        
        .mulch-indicator-text {
            font-size: 13px;
            color: #92400e;
            line-height: 1.4;
        }
        
        .mulch-indicator-text strong {
            font-weight: 600;
            color: #78350f;
        }
        
        /* Mulch button highlight when mulch needs measuring - subtle, no animation */
        .map-btn.mulch-needs-attention {
            background: #fffbeb;
            border-color: #fcd34d;
            color: #92400e;
        }
        .map-btn.mulch-needs-attention svg circle {
            fill: #d97706;
        }
        
        /* Mulch Calculator - Compact Design */
        .mulch-calculator {
            background: #f8faf9;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            margin-top: 12px;
        }
        
        .mulch-calc-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--green-dark);
            margin-bottom: 10px;
        }
        
        .mulch-calc-header svg {
            width: 14px;
            height: 14px;
        }
        
        .mulch-calc-row {
            display: flex;
            gap: 16px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        
        .mulch-calc-field {
            flex: 1;
        }
        
        .mulch-calc-field label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .mulch-calc-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }
        
        .thickness-selector {
            display: flex;
            gap: 4px;
        }
        
        .thickness-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .thickness-btn:hover {
            border-color: var(--green-light);
        }
        
        .thickness-btn.active {
            border-color: var(--green);
            background: var(--green);
            color: white;
        }
        
        .thickness-note {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            text-align: center;
        }
        
        .mulch-calc-result {
            display: flex;
            gap: 16px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        
        .mulch-cuft, .mulch-yards {
            flex: 1;
            text-align: center;
        }
        
        .cuft-value, .yards-value {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: var(--green-dark);
        }
        
        .cuft-label, .yards-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 28px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--green);
            color: white;
        }
        
        .btn-primary:hover { background: var(--green-dark); }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover { background: #e5e7eb; }
        
        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .btn-row .btn { flex: 1; }
        .btn-row .btn-secondary { flex: 0 0 30%; }
        .btn-row > div { flex: 0 0 68%; }
        .btn-row > div .btn { width: 100%; }
        
        /* Screen visibility */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Success Screen */
        .success-card {
            text-align: center;
            padding: 48px 24px;
        }
        
        .success-icon {
            width: 72px;
            height: 72px;
            background: var(--green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        
        .success-icon svg {
            width: 36px;
            height: 36px;
            color: var(--green);
        }
        
        .success-card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .success-card p {
            color: var(--text-muted);
            font-size: 15px;
            line-height: 1.6;
        }
        
        .success-logo {
            margin-bottom: 8px;
        }
        
        /* Widget Footer */
        .widget-footer {
            text-align: center;
            padding: 24px 16px;
            margin-top: 32px;
            font-size: 12px;
            color: var(--text-light);
        }
        
        /* Summary */
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
            font-size: 15px;
        }
        
        .summary-item:last-child { border-bottom: none; }
        
        .summary-label { color: var(--text-muted); }
        .summary-value { font-weight: 600; text-align: right; max-width: 60%; }
        
        /* Info Tooltip */
        .label-with-info {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-icon {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #e5e7eb;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            cursor: help;
            flex-shrink: 0;
        }
        
        .info-icon:hover {
            background: var(--green-light);
            color: var(--green-dark);
        }
        
        .info-tooltip {
            position: absolute;
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
            width: 220px;
            padding: 10px 12px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            z-index: 1000;
            pointer-events: none;
            text-align: left;
        }
        
        .info-tooltip::after {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1f2937;
        }
        
        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* ============================================
           PREMIUM MAGNIFIER - Pure CSS, No Network Lag
           Uses GPU-accelerated transforms only
           ============================================ */
        
        .magnifier-bubble {
            position: fixed;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            /* Clean white border, no blur (we have real map content now) */
            background: #1a1a1a;
            border: 3px solid rgba(255, 255, 255, 0.95);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(22, 163, 74, 0.5),
                inset 0 0 20px rgba(0, 0, 0, 0.3);
            /* GPU-accelerated positioning via transform */
            transform: translate(-50%, -50%) scale(0.8);
            will-change: transform, opacity;
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            overflow: hidden;
        }
        
        .magnifier-bubble.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Clean target reticle inside magnifier */
        .magnifier-content {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            overflow: hidden;
            /* This will hold the zoomed map view */
        }
        
        /* Zoomed map clone inside magnifier */
        .magnifier-map-clone {
            position: absolute;
            transform-origin: center center;
            pointer-events: none;
            /* 2.5x zoom for clear detail */
            transform: scale(2.5);
        }
        
        /* Crosshair lines */
        .magnifier-crosshair {
            position: absolute;
            inset: 0;
        }
        
        .magnifier-crosshair::before,
        .magnifier-crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .magnifier-crosshair::before {
            /* Horizontal line */
            top: 50%;
            left: 15%;
            right: 15%;
            height: 1px;
            transform: translateY(-50%);
        }
        
        .magnifier-crosshair::after {
            /* Vertical line */
            left: 50%;
            top: 15%;
            bottom: 15%;
            width: 1px;
            transform: translateX(-50%);
        }
        
        /* Center precision dot */
        .magnifier-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--green);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        /* Subtle pulse animation on the dot */
        .magnifier-bubble.active .magnifier-dot {
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 0 0 0 rgba(22, 163, 74, 0.4); }
            50% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 0 0 6px rgba(22, 163, 74, 0); }
        }
        
        /* Connecting line - clean gradient */
        .magnifier-line {
            position: fixed;
            width: 1px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(22, 163, 74, 0.6) 100%);
            pointer-events: none;
            z-index: 999;
            opacity: 0;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
            will-change: transform, opacity;
            transition: opacity 0.15s ease-out;
        }
        
        .magnifier-line.active {
            opacity: 1;
        }
        
        /* Placement indicator - where point lands */
        .placement-indicator {
            position: fixed;
            width: 16px;
            height: 16px;
            border: 2px solid var(--green);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 0 0 1px rgba(22, 163, 74, 0.2);
            pointer-events: none;
            z-index: 998;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
            will-change: transform, opacity;
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
        }
        
        .placement-indicator.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .placement-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5px;
            height: 5px;
            background: var(--green);
            border-radius: 50%;
        }
        
        /* Label - premium dark pill */
        .magnifier-label {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            padding: 6px 14px;
            border-radius: 20px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1001;
            opacity: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            will-change: transform, opacity;
            transition: opacity 0.15s ease-out;
        }
        
        .magnifier-label.active {
            opacity: 1;
        }
        
        /* Touch indicator - subtle ring at finger */
        .touch-indicator {
            position: fixed;
            width: 44px;
            height: 44px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 997;
            opacity: 0;
            transform: translate(-50%, -50%);
            will-change: transform, opacity;
            transition: opacity 0.1s ease-out;
        }
        
        .touch-indicator.active {
            opacity: 1;
        }
        
        /* Hide on desktop */
        @media (hover: hover) and (pointer: fine) {
            .magnifier-bubble,
            .magnifier-line,
            .placement-indicator,
            .magnifier-label,
            .touch-indicator { display: none !important; }
        }
        
        /* Google Places Autocomplete dropdown styling */
        .pac-container {
            border-radius: 10px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            margin-top: 4px;
        }
        
        .pac-item {
            padding: 10px 14px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .pac-item:hover {
            background: var(--green-light);
        }
        
        .pac-item-selected {
            background: var(--green-light);
        }
        
        .pac-icon {
            display: none;
        }
        
        .pac-item-query {
            font-size: 14px;
            color: var(--text);
        }
        
        /* Package Configuration Modal */
        .package-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .package-modal-overlay.show {
            display: flex;
        }
        
        .package-modal {
            background: white;
            border-radius: var(--radius);
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .package-modal-header {
            background: white;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .package-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }
        
        .package-modal-subtitle {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .package-modal-body {
            padding: 24px;
        }
        
        .package-section {
            margin-bottom: 24px;
        }
        
        .package-section:last-child {
            margin-bottom: 0;
        }
        
        .package-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .package-section-icon {
            width: 20px;
            height: 20px;
            background: var(--green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        
        /* Accordion/Collapsible Section */
        .package-accordion {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .package-accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #f9fafb;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .package-accordion-header:hover {
            background: #f3f4f6;
        }
        
        .package-accordion-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .package-accordion-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        
        .package-accordion-partner {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .package-accordion-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .package-accordion-count {
            font-size: 12px;
            color: var(--text-muted);
            background: white;
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .package-accordion-chevron {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        
        .package-accordion.open .package-accordion-chevron {
            transform: rotate(180deg);
        }
        
        .package-accordion-body {
            display: none;
            border-top: 1px solid var(--border);
        }
        
        .package-accordion.open .package-accordion-body {
            display: block;
        }
        
        .package-accordion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .package-accordion-item:last-child {
            border-bottom: none;
        }
        
        .package-accordion-item:hover {
            background: #fafafa;
        }
        
        .package-accordion-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--green);
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .package-accordion-item-content {
            flex: 1;
        }
        
        .package-accordion-item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        
        .package-accordion-item-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 1px;
        }
        
        /* Package Select Dropdown */
        .package-select {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--text);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }
        
        .package-select:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        
        /* Package Checkbox List */
        .package-checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .package-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .package-checkbox-item:hover {
            background: var(--green-light);
        }
        
        .package-checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--green);
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .package-checkbox-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .package-checkbox-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        
        .package-checkbox-note {
            font-size: 10px;
            color: var(--text-muted);
        }
        
        .package-modal-footer {
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        
        .package-modal-btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .package-modal-btn.cancel {
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .package-modal-btn.cancel:hover {
            background: #f3f4f6;
        }
        
        .package-modal-btn.done {
            background: var(--green);
            color: white;
            border: none;
            flex: 1;
        }
        
        .package-modal-btn.done:hover {
            background: var(--green-dark);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { max-width: 100%; padding: 32px 20px 100px; }
            .photo-modal { max-width: 95%; }
            .package-modal { max-width: 95%; }
        }
        
        @media (max-width: 480px) {
            .form-row { grid-template-columns: 1fr; }
            .container { padding: 24px 16px 100px; }
            .step span { display: none; }
            .service-pill { font-size: 12px; padding: 7px 12px; min-width: 100px; }
            .info-tooltip { width: 200px; }
            .packages-wrap { flex-direction: column; align-items: center; gap: 12px; }
            .package-btn { width: 100%; max-width: 320px; }
        }
    </style>
    <!-- html2canvas for map screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <script>
        // Auto-detect embed mode (in iframe or ?embed=true)
        (function() {
            const isInIframe = window.self !== window.top;
            const urlParams = new URLSearchParams(window.location.search);
            const embedParam = urlParams.get('embed');
            
            if (isInIframe || embedParam === 'true') {
                document.body.classList.add('embed-mode');
            }
        })();
    </script>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <!-- Logo removed -->
            <h1>Get Your Free Quote</h1>
            <p>Takes about 2 minutes</p>
        </div>
        
        <!-- Progress Steps -->
        <div class="steps">
            <div class="step active" id="step1">
                <div class="step-num">1</div>
                <span>Details</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step2">
                <div class="step-num">2</div>
                <span>Measure</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step3">
                <div class="step-num">3</div>
                <span>Done</span>
            </div>
        </div>
        
        <!-- Screen 1: Contact & Services -->
        <div class="screen active" id="screen1">
            <!-- Contact Info -->
            <div class="card">
                <div class="card-title">Contact Info</div>
                <div class="card-desc">We'll send your quote to this email</div>
                
                <div class="form-row">
                    <div class="field">
                        <label>Name <span style="color: #dc2626;">*</span></label>
                        <input type="text" id="name" placeholder="John Smith" required>
                    </div>
                    <div class="field">
                        <label>Phone <span style="color: #dc2626;">*</span></label>
                        <input type="tel" id="phone" placeholder="(720) 555-1234" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="field">
                        <label>
                            <span class="label-with-info">
                                Email <span style="color: #dc2626;">*</span>
                                <span class="info-icon">i
                                    <span class="info-tooltip">Please provide the best email to reach you. Service updates and invoicing will be sent here. We don't spam.</span>
                                </span>
                            </span>
                        </label>
                        <input type="email" id="email" placeholder="john@email.com" required>
                    </div>
                    <div class="field">
                        <label>How'd you find us? <span style="color: #dc2626;">*</span></label>
                        <select id="referralSource" required>
                            <option value="">Select...</option>
                            <option value="google">Google</option>
                            <option value="nextdoor">Nextdoor</option>
                            <option value="referral">Friend/Neighbor</option>
                            <option value="facebook">Facebook</option>
                            <option value="yard_sign">Yard Sign</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row single">
                    <div class="field">
                        <label>
                            <span class="label-with-info">
                                Service Address <span style="color: #dc2626;">*</span>
                                <span class="info-icon">i
                                    <span class="info-tooltip">Please double-check your address. You don't want to get quoted for the wrong property.</span>
                                </span>
                            </span>
                        </label>
                        <input type="text" id="address" placeholder="Start typing your address..." required autocomplete="off">
                    </div>
                </div>
            </div>
            
            <!-- Services -->
            <div class="card">
                <div class="card-title">Select Your Services</div>
                <div class="card-desc">Choose a package or pick individual services</div>
                
                <!-- Package Quick-Select -->
                <div class="packages-wrap">
                    <button type="button" class="package-btn" data-package="essential" onclick="selectPackage('essential')" onmouseenter="highlightPackageServices('essential')" onmouseleave="unhighlightPackageServices()">
                        <span class="package-name">Essentials</span>
                        <span class="package-tagline">Just the basics, done right</span>
                        <ul class="package-desc-list">
                            <li>Weekly Mowing</li>
                            <li>Lawn Aeration</li>
                            <li>Overseeding</li>
                            <li>Weed Control + Fertilizer</li>
                        </ul>
                        <div class="package-perks">
                            <span class="package-perks-label">Included</span>
                            <ul class="package-perks-list">
                                <li>Reliable scheduling</li>
                                <li>Cancel any time</li>
                                <li>Card on file</li>
                                <li>Customer portal access</li>
                            </ul>
                        </div>
                    </button>
                    <button type="button" class="package-btn" data-package="complete" onclick="selectPackage('complete')" onmouseenter="highlightPackageServices('complete')" onmouseleave="unhighlightPackageServices()">
                        <span class="package-badge popular">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            Most Popular
                        </span>
                        <span class="package-name">Complete</span>
                        <span class="package-tagline">Full-service lawn care</span>
                        <ul class="package-desc-list">
                            <li>Everything in Essentials</li>
                            <li>Bush Trimming</li>
                            <li>Power Raking</li>
                        </ul>
                        <div class="package-perks">
                            <span class="package-perks-label">Included</span>
                            <ul class="package-perks-list">
                                <li>Pre-scheduled services</li>
                                <li>Price locked all year</li>
                                <li>Cancel any time</li>
                                <li>Card on file</li>
                                <li>Customer portal access</li>
                            </ul>
                        </div>
                    </button>
                    <button type="button" class="package-btn" data-package="total" onclick="selectPackage('total')" onmouseenter="highlightPackageServices('total')" onmouseleave="unhighlightPackageServices()">
                        <span class="package-badge value">
                            VIP
                        </span>
                        <span class="package-name">Premium</span>
                        <span class="package-tagline">White-glove lawn care</span>
                        <ul class="package-desc-list">
                            <li>All services included</li>
                            <li>Bush Trimming</li>
                            <li>Mulch refresh included</li>
                        </ul>
                        <div class="package-perks">
                            <span class="package-perks-label">Included</span>
                            <ul class="package-perks-list">
                                <li>Priority scheduling</li>
                                <li>Priority support</li>
                                <li>Price locked all year</li>
                                <li>Cancel any time</li>
                                <li>Card on file</li>
                                <li>Customer portal access</li>
                            </ul>
                        </div>
                    </button>
                </div>
                
                <div class="services-divider">
                    <span>or select individual services</span>
                </div>
                
                <div class="services-wrap">
                    <!-- Mowing Service with dropdown -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillMowing" onclick="toggleServiceDropdown('mowing')">
                            <span class="pill-label">Mowing Service</span>
                            <span class="pill-sublabel" id="mowingSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="mowingDropdown">
                            <button type="button" class="dropdown-option" data-value="weekly" onclick="selectServiceOption('mowing', 'weekly', 'Weekly Mowing')">
                                <span class="dropdown-option-content">
                                    Weekly Mowing
                                    <span class="dropdown-note">Most popular</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" id="biweeklyOption" data-value="biweekly" onclick="selectServiceOption('mowing', 'biweekly', 'Bi-Weekly')">
                                <span class="dropdown-option-content">
                                    Bi-Weekly Mowing
                                    <span class="dropdown-note">Available after June 15 only</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option disabled" data-value="onetime" disabled>
                                <span class="dropdown-option-content">
                                    One-Time Mow
                                    <span class="dropdown-note">We do not offer one-time mowing</span>
                                </span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Aeration with pass options -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillAeration" onclick="toggleServiceDropdown('aeration')">
                            <span class="pill-label">Lawn Aeration</span>
                            <span class="pill-sublabel" id="aerationSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="aerationDropdown">
                            <button type="button" class="dropdown-option" data-value="single" onclick="selectServiceOption('aeration', 'single', 'Single Pass')">
                                <span class="dropdown-option-content">
                                    Single Pass
                                    <span class="dropdown-note">Standard service</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="double" onclick="selectServiceOption('aeration', 'double', 'Double Pass')">
                                <span class="dropdown-option-content">
                                    Double Pass
                                    <span class="dropdown-note">Maximum coverage</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overseeding with package options -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillOverseeding" onclick="toggleServiceDropdown('overseeding')">
                            <span class="pill-label">Overseeding</span>
                            <span class="pill-sublabel" id="overseedingSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="overseedingDropdown">
                            <button type="button" class="dropdown-option" data-value="standard" onclick="selectServiceOption('overseeding', 'standard', 'Standard')">
                                <span class="dropdown-option-content">
                                    Standard Overseeding
                                    <span class="dropdown-note">Best with existing thick lawn</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="complete" onclick="selectServiceOption('overseeding', 'complete', 'Complete Package')">
                                <span class="dropdown-option-content">
                                    Complete Package
                                    <span class="dropdown-note">+ Peat Moss + Starter Fertilizer</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <div class="dropdown-info">
                                Complete package recommended for bare spots or thin lawns
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fertilization with frequency dropdown -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillFertilization" onclick="toggleServiceDropdown('fertilization')">
                            <span class="pill-label">Fertilization</span>
                            <span class="pill-sublabel" id="fertilizationSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="fertilizationDropdown">
                            <button type="button" class="dropdown-option" data-value="onetime" onclick="selectServiceOption('fertilization', 'onetime', 'One-Time')">
                                <span class="dropdown-option-content">
                                    One-Time Service
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="recurring" onclick="selectServiceOption('fertilization', 'recurring', 'Every 4-6 Weeks')">
                                <span class="dropdown-option-content">
                                    Every 4-6 Weeks
                                    <span class="dropdown-note">Recommended for best results</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Weed Man Partner Services (Multi-Select) -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillWeedControl" onclick="toggleWeedManDropdown()">
                            <span class="pill-label">Weed Control</span>
                            <span class="pill-desc">+ Fertilizer</span>
                            <span class="pill-sublabel" id="weedControlSublabel"></span>
                        </button>
                        <div class="service-dropdown weedman-dropdown" id="weedControlDropdown">
                            <div class="weedman-header">
                                <div class="weedman-header-left">
                                    <span class="weedman-partner-badge">
                                        <span class="partner-title" style="display: flex; align-items: center; gap: 6px;">
                                            Official Partner
                                            <span class="info-icon">i
                                                <span class="info-tooltip" style="width: 240px;">We partner with Weed Man to provide professional fertilization and weed control. We handle all communication, scheduling, and billing!</span>
                                            </span>
                                        </span>
                                        <span class="partner-link">with <a href="https://weedman.com/en-us/denver" target="_blank" rel="noopener">Weed Man</a> â†—</span>
                                    </span>
                                </div>
                                <button type="button" class="weedman-done-btn" onclick="closeWeedManDropdown()">
                                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    Done
                                </button>
                            </div>
                            <div class="weedman-options">
                                <label class="weedman-option" data-value="weed_control_fertilizer">
                                    <input type="checkbox" onchange="updateWeedManSelection()">
                                    <span class="weedman-option-content">
                                        <span class="weedman-option-name">Weed Control and Fertilizer</span>
                                        <span class="weedman-option-note">Every 4-6 weeks</span>
                                    </span>
                                </label>
                                <label class="weedman-option" data-value="insect_control">
                                    <input type="checkbox" onchange="updateWeedManSelection()">
                                    <span class="weedman-option-content">
                                        <span class="weedman-option-name">Insect Control</span>
                                        <span class="weedman-option-note">Surface-feeding insects</span>
                                    </span>
                                </label>
                                <label class="weedman-option" data-value="crabgrass_control">
                                    <input type="checkbox" onchange="updateWeedManSelection()">
                                    <span class="weedman-option-content">
                                        <span class="weedman-option-name">Crabgrass Control</span>
                                        <span class="weedman-option-note">Pre-emergent treatment</span>
                                    </span>
                                </label>
                                <label class="weedman-option" data-value="mosquito_control">
                                    <input type="checkbox" onchange="updateWeedManSelection()">
                                    <span class="weedman-option-content">
                                        <span class="weedman-option-name">Mosquito Control</span>
                                        <span class="weedman-option-note">Yard perimeter treatment</span>
                                    </span>
                                </label>
                                <label class="weedman-option" data-value="grub_control">
                                    <input type="checkbox" onchange="updateWeedManSelection()">
                                    <span class="weedman-option-content">
                                        <span class="weedman-option-name">Grub Control</span>
                                        <span class="weedman-option-note">Prevents lawn damage from grubs</span>
                                    </span>
                                </label>
                                <label class="weedman-option" data-value="perimeter_pest">
                                    <input type="checkbox" onchange="updateWeedManSelection()">
                                    <span class="weedman-option-content">
                                        <span class="weedman-option-name">Perimeter Pest Control</span>
                                        <span class="weedman-option-note">Home foundation barrier</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mulch Install with color dropdown -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillMulch" onclick="toggleServiceDropdown('mulch')">
                            <span class="pill-label">Mulch Install</span>
                            <span class="pill-sublabel" id="mulchSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="mulchDropdown">
                            <button type="button" class="dropdown-option" data-value="brown" onclick="selectServiceOption('mulch', 'brown', 'Brown')">
                                <span class="dropdown-option-content">
                                    Brown Mulch
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="red" onclick="selectServiceOption('mulch', 'red', 'Red')">
                                <span class="dropdown-option-content">
                                    Red Mulch
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="black" onclick="selectServiceOption('mulch', 'black', 'Black')">
                                <span class="dropdown-option-content">
                                    Black Mulch
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Yard Cleanup with type dropdown -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillYardCleanup" onclick="toggleServiceDropdown('yardCleanup')">
                            <span class="pill-label">Yard Cleanup</span>
                            <span class="pill-sublabel" id="yardCleanupSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="yardCleanupDropdown">
                            <button type="button" class="dropdown-option" data-value="leaf_cleanup" onclick="selectServiceOption('yardCleanup', 'leaf_cleanup', 'Leaf Cleanup')">
                                <span class="dropdown-option-content">
                                    Leaf Cleanup
                                    <span class="dropdown-note">Leaves only</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="complete_cleanup" onclick="selectServiceOption('yardCleanup', 'complete_cleanup', 'Complete Yard Cleanup')">
                                <span class="dropdown-option-content">
                                    Complete Yard Cleanup
                                    <span class="dropdown-note">All yard debris: leaves, pine needles, twigs, branches, etc.</span>
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Power Raking -->
                    <button type="button" class="service-pill" data-service="power_raking" onclick="toggleSimpleService(this)">
                        <span class="pill-label">Power Raking</span>
                    </button>
                    
                    <!-- Bush Trimming with frequency dropdown -->
                    <div class="service-with-dropdown">
                        <button type="button" class="service-pill" id="pillBushTrimming" onclick="toggleServiceDropdown('bushTrimming')">
                            <span class="pill-label">Bush Trimming</span>
                            <span class="pill-sublabel" id="bushTrimmingSublabel"></span>
                        </button>
                        <div class="service-dropdown" id="bushTrimmingDropdown">
                            <button type="button" class="dropdown-option" data-value="onetime" onclick="selectServiceOption('bushTrimming', 'onetime', 'One-Time')">
                                <span class="dropdown-option-content">
                                    One-Time Service
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="monthly" onclick="selectServiceOption('bushTrimming', 'monthly', 'Once a Month')">
                                <span class="dropdown-option-content">
                                    Once a Month
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="bimonthly" onclick="selectServiceOption('bushTrimming', 'bimonthly', 'Every 2 Months')">
                                <span class="dropdown-option-content">
                                    Every 2 Months
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                            <button type="button" class="dropdown-option" data-value="quarterly" onclick="selectServiceOption('bushTrimming', 'quarterly', 'Every 3 Months')">
                                <span class="dropdown-option-content">
                                    Every 3 Months
                                </span>
                                <span class="dropdown-deselect">Ã—</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- One-time mow warning -->
                <div class="info-note danger" id="onetimeNote">
                    âš ï¸ One-time mow service is <strong>$115 minimum</strong>, regardless of yard size. Price subject to change based on actual lawn condition.
                </div>
            </div>
            
            <!-- Property Details (hidden until service selected) -->
            <div class="card conditional-section" id="propertyDetailsCard" style="display: none;">
                <div class="card-title">Property Details</div>
                <div class="card-desc">Help us give you the most accurate quote</div>
                
                <!-- Gate Question -->
                <div class="question-section">
                    <div class="question-row">
                        <span class="question-text">Do you have a gate? <span style="color: #dc2626;">*</span></span>
                        <div class="toggle-group">
                            <button type="button" class="toggle-btn" onclick="setGate(false)" id="gateNo">No</button>
                            <button type="button" class="toggle-btn" onclick="setGate(true)" id="gateYes">Yes</button>
                        </div>
                    </div>
                    
                    <!-- Gate follow-up questions -->
                    <div class="conditional-field" id="gateDetails">
                        <label>How wide is your gate?</label>
                        <div class="gate-slider-container">
                            <div class="gate-slider-row">
                                <div class="gate-slider-wrapper">
                                    <input type="range" id="gateSlider" class="gate-slider" min="0" max="100" value="36" oninput="syncGateFromSlider(this.value)">
                                    <div class="gate-slider-labels">
                                        <span>0"</span>
                                        <span>32" min</span>
                                        <span>100"</span>
                                    </div>
                                </div>
                                <div class="gate-live-value" id="gateLiveValue">36"</div>
                                <div class="gate-input-group">
                                    <input type="number" id="gateWidth" placeholder="36" min="0" max="120" oninput="syncGateFromInput(this.value)">
                                    <span>inches</span>
                                </div>
                            </div>
                            <div class="gate-slider-hint">Slide or type to set gate width</div>
                        </div>
                        
                        <div class="inline-warning" id="gateWarning">
                            âš ï¸ <strong>Backyard not serviceable for mowing/aeration.</strong> Your gate is under 32" wide â€” we cannot fit our equipment through. These services would be front yard only.
                        </div>
                        
                        <div class="inline-warning" id="gateWarningCleanup">
                            âš ï¸ <strong>Backyard not serviceable for cleanup.</strong> Your gate is under 25" wide â€” we cannot fit our equipment through. Cleanup services would be front yard only.
                        </div>
                        
                        <div class="inline-success" id="gateSuccess">
                            You're good to go! Gate width is sufficient for all services.
                        </div>
                        
                        <div class="gate-code-section" style="margin-top: 16px;">
                            <label>Enter your gate code (optional)</label>
                            <div class="inline-input">
                                <input type="text" id="gateCode" placeholder="1234" class="wider">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dog Question -->
                <div class="question-section">
                    <div class="question-row">
                        <span class="question-text">Do you have dog(s)? <span style="color: #dc2626;">*</span></span>
                        <div class="toggle-group">
                            <button type="button" class="toggle-btn" onclick="setDog(false)" id="dogNo">No</button>
                            <button type="button" class="toggle-btn" onclick="setDog(true)" id="dogYes">Yes</button>
                        </div>
                    </div>
                    
                    <div class="conditional-field" id="dogWarning">
                        <label class="sms-consent-checkbox" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 14px 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--radius-sm); font-size: 13px; color: var(--text); line-height: 1.5; margin-top: 10px;">
                            <input type="checkbox" id="dogConfirm" onchange="updateDogConfirm()" style="width: 18px; height: 18px; margin-top: 2px; accent-color: var(--green); cursor: pointer; flex-shrink: 0;">
                            <span>I confirm my dog(s) will be kept inside and the yard will be free of waste during service. <span style="color: #92400e; font-weight: 500;">We are not responsible for pet injuries/escapes and a cleaning fee may apply.</span></span>
                        </label>
                    </div>
                </div>
                
                <!-- Overgrown Question -->
                <div class="question-section">
                    <div class="question-row">
                        <span class="question-text">Is your lawn overgrown? <span style="color: #dc2626;">*</span></span>
                        <div class="toggle-group overgrown-toggle">
                            <button type="button" class="toggle-btn" onclick="setOvergrown(false)" id="overgrownNo">No</button>
                            <button type="button" class="toggle-btn" onclick="setOvergrown(true)" id="overgrownYes">
                                Yes
                            </button>
                        </div>
                    </div>
                    
                    <div class="conditional-field" id="overgrownDetails">
                        <label>Approximately how tall is the grass?</label>
                        <div class="inline-input">
                            <input type="number" id="grassHeight" placeholder="8" min="1" max="48">
                            <span>inches</span>
                        </div>
                        
                        <div class="inline-warning show">
                            âš ï¸ Overgrown lawns require additional time and may affect pricing. Photos help us give you a more accurate quote without an in-person visit.
                        </div>
                    </div>
                </div>
                
                <!-- Stairs Question -->
                <div class="question-section">
                    <div class="question-row">
                        <span class="question-text">Are there stairs to the backyard? <span style="color: #dc2626;">*</span></span>
                        <div class="toggle-group">
                            <button type="button" class="toggle-btn" onclick="setStairs(false)" id="stairsNo">No</button>
                            <button type="button" class="toggle-btn" onclick="setStairs(true)" id="stairsYes">Yes</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Photo Upload (shows for specific services requiring visual estimate) -->
            <div class="card photo-section" id="photoSection">
                <div class="photo-header">
                    <div class="card-title">Photos</div>
                    <div class="photo-toggle" id="photoToggle" onclick="togglePhotoSection()">
                        <div class="photo-toggle-knob"></div>
                    </div>
                </div>
                <div class="card-desc">Submit photos for faster, more accurate quotes</div>
                
                <div class="photo-content" id="photoContent">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                        </div>
                        <div class="upload-text">Tap to upload photos</div>
                        <div class="upload-hint">Or drag and drop images here</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotos(this.files)" style="display:none;">
                    <div class="photo-preview" id="photoPreview"></div>
                    <div class="photo-count" id="photoCount"></div>
                </div>
                
                <!-- Photo Skip Confirmation - Inline -->
                <div class="photo-modal-overlay" id="photoSkipModal">
                    <div class="photo-modal">
                        <div class="photo-modal-title">Skip photos?</div>
                        <div class="photo-modal-warning">
                            <strong>Without photos</strong>, we'll need to schedule an in-person estimate before we can quote.
                        </div>
                        <div class="photo-modal-buttons">
                            <button type="button" class="photo-modal-btn primary" onclick="cancelPhotoSkip()">
                                Add Photos
                            </button>
                            <button type="button" class="photo-modal-btn secondary" onclick="confirmPhotoSkip()">
                                Continue Without Photos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Package Configuration Modal (VIP) -->
            <div class="package-modal-overlay" id="packageConfigModal">
                <div class="package-modal">
                    <div class="package-modal-header">
                        <div class="package-modal-title">Customize Package</div>
                        <div class="package-modal-subtitle">Select your preferences for VIP package</div>
                    </div>
                    <div class="package-modal-body">
                        <!-- Mulch Color -->
                        <div class="package-section">
                            <div class="package-section-title">Mulch Color</div>
                            <select class="package-select" id="packageMulchColor">
                                <option value="">Select mulch color...</option>
                                <option value="brown">Brown Mulch</option>
                                <option value="black">Black Mulch</option>
                                <option value="red">Red Mulch</option>
                            </select>
                        </div>
                        
                        <!-- Weed Man Services (Accordion) -->
                        <div class="package-section">
                            <div class="package-accordion" id="weedServicesAccordion" onclick="toggleWeedAccordion(event)">
                                <div class="package-accordion-header">
                                    <div class="package-accordion-left">
                                        <div class="package-accordion-title">Weed Control Services</div>
                                        <div class="package-accordion-partner">Official Partner with Weed Man</div>
                                    </div>
                                    <div class="package-accordion-right">
                                        <span class="package-accordion-count" id="weedServicesCount">1 selected</span>
                                        <svg class="package-accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                    </div>
                                </div>
                                <div class="package-accordion-body" id="packageWeedServices">
                                    <label class="package-accordion-item" data-value="weed_control_fertilizer">
                                        <input type="checkbox" checked onchange="updateWeedCount()">
                                        <div class="package-accordion-item-content">
                                            <div class="package-accordion-item-name">Weed Control & Fertilizer</div>
                                            <div class="package-accordion-item-note">Base package â€¢ Every 4-6 weeks</div>
                                        </div>
                                    </label>
                                    <label class="package-accordion-item" data-value="crabgrass_control">
                                        <input type="checkbox" onchange="updateWeedCount()">
                                        <div class="package-accordion-item-content">
                                            <div class="package-accordion-item-name">Crabgrass Control</div>
                                            <div class="package-accordion-item-note">Pre-emergent treatment</div>
                                        </div>
                                    </label>
                                    <label class="package-accordion-item" data-value="insect_control">
                                        <input type="checkbox" onchange="updateWeedCount()">
                                        <div class="package-accordion-item-content">
                                            <div class="package-accordion-item-name">Insect Control</div>
                                            <div class="package-accordion-item-note">Surface-feeding insects</div>
                                        </div>
                                    </label>
                                    <label class="package-accordion-item" data-value="grub_control">
                                        <input type="checkbox" onchange="updateWeedCount()">
                                        <div class="package-accordion-item-content">
                                            <div class="package-accordion-item-name">Grub Control</div>
                                            <div class="package-accordion-item-note">Prevents lawn damage from grubs</div>
                                        </div>
                                    </label>
                                    <label class="package-accordion-item" data-value="mosquito_control">
                                        <input type="checkbox" onchange="updateWeedCount()">
                                        <div class="package-accordion-item-content">
                                            <div class="package-accordion-item-name">Mosquito Control</div>
                                            <div class="package-accordion-item-note">Yard perimeter treatment</div>
                                        </div>
                                    </label>
                                    <label class="package-accordion-item" data-value="perimeter_pest">
                                        <input type="checkbox" onchange="updateWeedCount()">
                                        <div class="package-accordion-item-content">
                                            <div class="package-accordion-item-name">Perimeter Pest Control</div>
                                            <div class="package-accordion-item-note">Home foundation barrier</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bush Trimming Frequency -->
                        <div class="package-section">
                            <div class="package-section-title">Bush Trimming Frequency</div>
                            <select class="package-select" id="packageBushFrequency">
                                <option value="">Select frequency...</option>
                                <option value="monthly">Once a Month</option>
                                <option value="bimonthly" selected>Every 2 Months (Recommended)</option>
                                <option value="quarterly">Every 3 Months</option>
                            </select>
                        </div>
                    </div>
                    <div class="package-modal-footer">
                        <button type="button" class="package-modal-btn cancel" onclick="cancelPackageConfig()">Cancel</button>
                        <button type="button" class="package-modal-btn done" onclick="applyPackageConfig()">Apply Selections</button>
                    </div>
                </div>
            </div>
            
            <!-- Notes (hidden until service selected) -->
            <div class="card notes-section conditional-section" id="additionalNotesCard" style="display: none;">
                <div class="card-title">Additional Notes</div>
                <div class="card-desc">Any special requests, access instructions, or details we should know (optional)</div>
                <textarea id="notes" rows="3" placeholder="E.g., gate code is 1234, please text before arriving..."></textarea>
            </div>
            
            <!-- SMS Consent (Required) -->
            <div class="sms-consent" style="margin-bottom: 20px;">
                <label class="sms-consent-checkbox" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 14px 16px; background: #f9fafb; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                    <input type="checkbox" id="smsConsent" style="width: 18px; height: 18px; margin-top: 2px; accent-color: var(--green); cursor: pointer; flex-shrink: 0;">
                    <span>I agree to receive texts and emails from No Mow Worries. Reply STOP to opt out. <span style="color: #dc2626;">*</span> <a href="https://nomowworriesco.com/privacy-policy/" target="_blank" style="color: var(--green); text-decoration: none;">Privacy Policy</a></span>
                </label>
            </div>
            
            <div class="btn-row">
                <button type="button" class="btn btn-primary" onclick="goToStep2()">
                    Continue
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
        
        <!-- Screen 2: Map -->
        <div class="screen" id="screen2">
            <!-- Measurement Importance Notice -->
            <div class="measurement-notice">
                <div class="measurement-notice-header">
                    <div class="measurement-notice-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                    </div>
                    <div>
                        <div class="measurement-notice-title">One Quick Step</div>
                        <div class="measurement-notice-subtitle">Draw your lawn to get accurate pricing</div>
                    </div>
                </div>
                
                <div class="measurement-notice-body" id="measurementNoticeBody">
                    <!-- Populated dynamically based on selected services -->
                </div>
                
                <div class="measurement-services" id="sqftServicesList">
                    <!-- Populated dynamically based on selected services -->
                </div>
                
                <div class="measurement-notice-footer">
                    <svg class="measurement-notice-footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <div class="measurement-notice-footer-text">
                        Your measurement is saved with your request. If your actual lawn size differs significantly, pricing may need adjustment. Take a moment to be as accurate as possible.
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div class="map-instructions">
                    <strong>Outline your lawn area</strong> â€” Tap corners to draw. <span class="mobile-hint">Hold to precisely place points above your finger.</span>
                </div>
                <div class="map-wrapper">
                    <div id="map"></div>
                    <div class="point-badge" id="pointCounter" style="display: none;"></div>
                    <!-- Mobile Precision Mode Elements -->
                    <!-- Magnifier bubble (shows zoomed view where point will be placed) -->
                    <div class="magnifier-bubble" id="magnifierBubble">
                        <div class="magnifier-content" id="magnifierContent"></div>
                        <div class="magnifier-crosshair"></div>
                        <div class="magnifier-dot"></div>
                    </div>
                    <!-- Line connecting magnifier to placement point -->
                    <div class="magnifier-line" id="magnifierLine"></div>
                    <!-- Label above magnifier -->
                    <div class="magnifier-label" id="magnifierLabel">Release to place</div>
                    <!-- Indicator at the actual placement point (offset above finger) -->
                    <div class="placement-indicator" id="placementIndicator"></div>
                    <!-- Touch indicator at finger position -->
                    <div class="touch-indicator" id="touchIndicator"></div>
                    <!-- Help Menu (inside map-wrapper for proper overlay) -->
                    <div class="help-menu" id="helpMenu" style="display: none;">
                        <div class="help-menu-content">
                            <div class="help-menu-title">How to Measure</div>
                            <ul class="help-menu-list">
                                <li><strong>Tap points</strong> around your lawn to draw a shape</li>
                                <li><strong>Tap near the first point</strong> (green dot) to close the shape</li>
                                <li><strong>Double-tap a shape</strong> to edit its corners</li>
                                <li><strong>Drag corners</strong> to adjust the shape</li>
                                <li><strong>Subtract</strong> areas like pools, patios, or gardens from lawn or mulch totals</li>
                                <li><strong>Undo</strong> removes the last point you added</li>
                            </ul>
                            <button type="button" class="help-menu-close" onclick="toggleHelpMenu()">Got it</button>
                        </div>
                    </div>
                </div>
                <div class="map-toolbar">
                    <button type="button" class="map-btn active" id="btnLawn" onclick="setDrawMode('lawn')">
                        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>
                        Lawn
                    </button>
                    <button type="button" class="map-btn" id="btnMulch" onclick="setDrawMode('mulch')">
                        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>
                        Mulch
                    </button>
                    <button type="button" class="map-btn" id="btnSubtract" onclick="setDrawMode('subtract')" title="Subtract areas from lawn or mulch beds (pools, patios, gardens, etc.)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                        Subtract
                    </button>
                    <button type="button" class="map-btn" onclick="undoLastPoint()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h10a5 5 0 0 1 5 5v2M3 10l4-4M3 10l4 4"/></svg>
                        Undo
                    </button>
                    <button type="button" class="map-btn finish-btn" id="finishBtn" onclick="finishPolygon()" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                        Done
                    </button>
                    <button type="button" class="map-btn danger" id="clearAllBtn" onclick="clearAllAreas()" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Clear
                    </button>
                    <button type="button" class="map-btn" onclick="toggleHelpMenu()" title="How to use">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        Help
                    </button>
                </div>
                
                <!-- Mulch Measurement Indicator (shows when mulch is selected but not measured) -->
                <div class="mulch-indicator" id="mulchIndicator" style="display: none;">
                    <div class="mulch-indicator-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                    </div>
                    <div class="mulch-indicator-text">
                        <strong>Mulch beds not measured yet.</strong> Tap "Mulch" above and outline your flower beds to include them in your quote.
                    </div>
                </div>
                
                <div class="map-result" id="mapResult" style="display: none;">
                    <div class="map-result-label">Measured Areas</div>
                    <div class="map-result-value" id="totalSqft">0 sq ft</div>
                    <div class="area-chips" id="areaList"></div>
                </div>
                
                <!-- Mulch Calculator (only shows when mulch areas are drawn) -->
                <div class="mulch-calculator" id="mulchCalculator" style="display: none;">
                    <div class="mulch-calc-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        <span>Mulch Calculator</span>
                    </div>
                    <div class="mulch-calc-row">
                        <div class="mulch-calc-field">
                            <label>Area</label>
                            <div class="mulch-calc-value" id="mulchSqftDisplay">0 sq ft</div>
                        </div>
                        <div class="mulch-calc-field">
                            <label>Depth <span style="font-weight: 400; color: #6b7280; font-size: 11px;">(3" recommended)</span></label>
                            <div class="thickness-selector">
                                <button type="button" class="thickness-btn" data-inches="2" onclick="setMulchThickness(2)">2"</button>
                                <button type="button" class="thickness-btn active" data-inches="3" onclick="setMulchThickness(3)">3"</button>
                                <button type="button" class="thickness-btn" data-inches="4" onclick="setMulchThickness(4)">4"</button>
                            </div>
                        </div>
                    </div>
                    <div class="mulch-calc-result">
                        <div class="mulch-cuft">
                            <span class="cuft-value" id="mulchCuFt">0</span>
                            <span class="cuft-label">cu ft</span>
                        </div>
                        <div class="mulch-yards">
                            <span class="yards-value" id="mulchYards">0</span>
                            <span class="yards-label">cu yds</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-row" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="goToStep1()">Back</button>
                <button type="button" class="btn btn-primary" onclick="goToStep3()">Review & Submit</button>
            </div>
        </div>
        
        <!-- Screen 3: Review & Submit -->
        <div class="screen" id="screen3">
            <div class="card">
                <div class="card-title" style="text-align: center;">Review Your Request</div>
                <div class="card-desc" style="text-align: center;">Make sure everything looks correct</div>
                
                <div class="summary-item">
                    <span class="summary-label">Name</span>
                    <span class="summary-value" id="summaryName">â€”</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Email</span>
                    <span class="summary-value" id="summaryEmail">â€”</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Phone</span>
                    <span class="summary-value" id="summaryPhone">â€”</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Address</span>
                    <span class="summary-value" id="summaryAddress">â€”</span>
                </div>
                <div class="summary-item" id="packageRow" style="display: none;">
                    <span class="summary-label">Package</span>
                    <span class="summary-value" id="summaryPackage" style="font-weight: 600; color: #059669;">â€”</span>
                </div>
                <div class="summary-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                    <span class="summary-label">Services</span>
                    <div class="summary-value" id="summaryServices" style="width: 100%; text-align: left; line-height: 1.6;">â€”</div>
                </div>
                <!-- Weed Control Services (Official Partner branding) -->
                <div id="weedManRow" class="summary-item" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; border-bottom: 1px solid #e5e7eb; padding: 12px 0; margin: 0;">
                    <!-- Header row: Title + Partner badge inline -->
                    <div style="display: flex; align-items: baseline; gap: 8px; width: 100%;">
                        <span class="summary-label" style="font-weight: 600;">Weed Control Services</span>
                        <span style="font-size: 11px; color: #9ca3af;">Official Partner with <a href="https://weedman.com/en-us/denver" target="_blank" rel="noopener" style="color: #16a34a; font-weight: 500; text-decoration: none;">Weed Man</a></span>
                    </div>
                    <!-- Selected services as bullet list -->
                    <div class="summary-value" id="summaryWeedMan" style="width: 100%; text-align: left; line-height: 1.6;">â€”</div>
                    <!-- Payment preference toggle -->
                    <div id="weedManPrepayRow" style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                        <span style="font-size: 12px; color: #6b7280;">Payment preference:</span>
                        <div style="display: flex; background: #f3f4f6; border-radius: 6px; padding: 2px; gap: 2px;">
                            <label style="cursor: pointer;">
                                <input type="radio" name="weedManPayment" value="prepay" style="display: none;" onchange="updateWeedManPayment()">
                                <span class="payment-toggle-btn" style="display: flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 5px; font-size: 12px; color: #6b7280; transition: all 0.15s;">
                                    Pay in Full <span style="font-size: 10px; font-weight: 600; color: #16a34a;">5% off</span>
                                </span>
                            </label>
                            <label style="cursor: pointer;">
                                <input type="radio" name="weedManPayment" value="per_service" checked style="display: none;" onchange="updateWeedManPayment()">
                                <span class="payment-toggle-btn payment-active" style="display: block; padding: 5px 10px; border-radius: 5px; font-size: 12px; background: white; color: #111827; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.15s;">
                                    Per Service
                                </span>
                            </label>
                        </div>
                        <span class="info-icon" style="color: #9ca3af; border-color: #d1d5db; font-size: 10px; width: 14px; height: 14px; line-height: 14px;">i
                            <span class="info-tooltip" style="width: 260px; font-size: 12px;">Prepay discount applies to <strong>Weed Control services only</strong>. Our services are billed per visit.</span>
                        </span>
                    </div>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Lawn Size</span>
                    <span class="summary-value" id="summarySqft">â€”</span>
                </div>
                <div class="summary-item" id="mulchRow" style="display: none;">
                    <span class="summary-label">Mulch Beds</span>
                    <span class="summary-value" id="summaryMulch">â€”</span>
                </div>
                <div class="summary-item" id="gateRow" style="display: none;">
                    <span class="summary-label">Gate</span>
                    <span class="summary-value" id="summaryGate">â€”</span>
                </div>
                <div class="summary-item" id="overgrownRow" style="display: none;">
                    <span class="summary-label">Lawn Condition</span>
                    <span class="summary-value" id="summaryOvergrown">â€”</span>
                </div>
                <div class="summary-item" id="dogsRow" style="display: none;">
                    <span class="summary-label">Dogs</span>
                    <span class="summary-value" id="summaryDogs">â€”</span>
                </div>
                <div class="summary-item" id="stairsRow" style="display: none;">
                    <span class="summary-label">Stairs to Backyard</span>
                    <span class="summary-value" id="summaryStairs">â€”</span>
                </div>
            </div>
            
            <!-- Mowing Disclaimer Notice (accuracy + first service subject to change) -->
            <div id="overgrownDisclaimer" style="display: none; padding: 12px 16px; background: #fefce8; border: 1px solid #facc15; border-radius: 8px; margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="color: #ca8a04; font-size: 16px; flex-shrink: 0;"></span>
                    <div style="color: #713f12;">
                        <strong>Please note:</strong> You've indicated your lawn is in normal condition. Your quote is based on the square footage you provided. If our crew arrives and finds the lawn overgrown or significantly larger than indicated, the first service price may be adjusted. We'll always confirm with you before starting work.
                    </div>
                </div>
            </div>
            
            <!-- Compact Notice: Lawn IS overgrown -->
            <div id="overgrownYesDisclaimer" style="display: none; padding: 12px 16px; background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
                <div style="color: #7f1d1d;">
                    <strong>Overgrown lawn:</strong> An overgrown fee may apply based on condition. We'll assess and confirm pricing before starting any work.
                </div>
            </div>
            
            <!-- Optional Notes Section -->
            <div style="margin-bottom: 16px;">
                <label for="customerNotes" style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 6px;">
                    Anything else we should know? <span style="font-weight: normal; color: #9ca3af;">(optional)</span>
                </label>
                <textarea id="customerNotes" placeholder="e.g., &quot;I'm not 100% sure about my square footage&quot; or &quot;Backyard has a tricky slope&quot;" style="width: 100%; min-height: 60px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
            </div>
            
            <div class="btn-row">
                <button type="button" class="btn btn-secondary" onclick="goBackFromStep3()">Back</button>
                <div style="position: relative; display: inline-block;">
                    <button type="button" class="btn btn-primary" id="submitBtn" onclick="submitQuote()">
                        Submit Quote Request
                    </button>
                    <div id="submitTooltip" style="display: none; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        Your quote will be sent via email
                        <div style="position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1f2937;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Success Screen -->
        <div class="screen" id="screenSuccess">
            <div class="card success-card">
                <!-- Logo removed -->
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M20 6L9 17l-5-5"/>
                    </svg>
                </div>
                <h2>Request Submitted!</h2>
                <p>We'll review your request and send a quote to your email within 24 hours. For most requests, you'll hear from us much sooner.</p>
                <div class="success-footer">
                    <p style="font-size: 13px; color: var(--text-muted); margin-top: 24px;">
                        <strong>No Mow Worries Lawn Care</strong><br>
                        Aurora, Colorado<br>
                        <a href="tel:7204465303" style="color: var(--green); text-decoration: none;">(720) 446-5303</a> â€¢ 
                        <a href="https://nomowworriesco.com" target="_blank" style="color: var(--green); text-decoration: none;">nomowworriesco.com</a>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Professional Footer -->
        <div class="widget-footer">
            <span>Â© 2025 No Mow Worries Lawn Care LLC â€¢ Aurora, CO</span>
        </div>
    </div>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDutgNGfggQz618lCQZkBVkMZkE0xtDRKQ&libraries=drawing,geometry,places"></script>
    <script>
        // State
        let selectedServices = {};
        let mowingType = null;
        let fertilizationType = null;
        let mulchColor = null;
        let bushTrimmingFrequency = null;
        let aerationType = null;
        let overseedingType = null;
        let hasGate = null;
        let gateWidth = null;
        let gateCode = null;
        let hasDog = null;
        let dogConfirmed = false;
        let isOvergrown = null;
        let grassHeight = null;
        let hasStairs = null;
        let photos = [];
        let map = null;
        let drawMode = 'lawn';
        let lawnPolygons = [];
        let mulchPolygons = [];
        let currentPoints = [];
        let currentPolyline = null;
        let totalLawnSqft = 0;
        let totalMulchSqft = 0;
        let markers = [];
        let mulchThickness = 3; // Default 3 inches (recommended)
        let measurementSkipped = false; // Track if step 2 was skipped
        let selectedPackage = null; // Track which package was selected: 'essential', 'complete', 'total', or null (custom)
        let packageWasEdited = false; // Track if user modified services after selecting a package
        
        // Service state tracking
        let serviceSelections = {
            mowing: null,
            fertilization: null,
            mulch: null,
            bushTrimming: null,
            aeration: null,
            overseeding: null,
            yardCleanup: null
        };
        
        // Check if biweekly should be enabled (after June 15)
        function isBiweeklyAvailable() {
            const now = new Date();
            const month = now.getMonth(); // 0-11
            const day = now.getDate();
            // June = 5, so if month > 5 OR (month === 5 AND day >= 15)
            return month > 5 || (month === 5 && day >= 15);
        }
        
        // Populate the sqft-based services list in the measurement notice
        function populateSqftServicesList() {
            const container = document.getElementById('sqftServicesList');
            const bodyEl = document.getElementById('measurementNoticeBody');
            if (!container) return;
            
            const services = [];
            const serviceNames = [];
            
            // Check which sqft-dependent services are selected (lawn-based)
            if (selectedServices.mowing) {
                services.push({ name: 'Lawn Mowing', icon: 'grass' });
                serviceNames.push('mowing');
            }
            if (selectedServices.aeration) {
                services.push({ name: 'Core Aeration', icon: 'dots' });
                serviceNames.push('aeration');
            }
            if (selectedServices.overseeding) {
                services.push({ name: 'Overseeding', icon: 'seed' });
                serviceNames.push('overseeding');
            }
            if (selectedServices.fertilization) {
                services.push({ name: 'Fertilization', icon: 'leaf' });
                serviceNames.push('fertilization');
            }
            if (selectedServices.power_raking) {
                services.push({ name: 'Power Rake', icon: 'rake' });
                serviceNames.push('power raking');
            }
            if (selectedServices.mulch) {
                services.push({ name: 'Mulch Install', icon: 'mulch' });
                serviceNames.push('mulch');
            }
            
            // Build dynamic message based on selected services
            if (bodyEl) {
                let message = '';
                const hasMulchOnly = serviceNames.length === 1 && serviceNames[0] === 'mulch';
                const hasLawnServices = serviceNames.some(s => s !== 'mulch');
                const hasMulch = serviceNames.includes('mulch');
                
                if (hasMulchOnly) {
                    message = 'Your mulch pricing is based on the area of your beds. Outline each bed to get an accurate quote.';
                } else if (hasLawnServices && hasMulch) {
                    // Both lawn and mulch services
                    const lawnNames = serviceNames.filter(s => s !== 'mulch');
                    if (lawnNames.length === 1) {
                        message = `Your ${lawnNames[0]} and mulch pricing are based on square footage. Outline your lawn area, then draw your mulch beds.`;
                    } else {
                        message = `Your ${lawnNames.slice(0, -1).join(', ')} and ${lawnNames[lawnNames.length - 1]} pricing are based on lawn size, and mulch is based on bed area. Draw both to get accurate quotes.`;
                    }
                } else if (hasLawnServices) {
                    // Lawn services only
                    if (serviceNames.length === 1) {
                        message = `Your ${serviceNames[0]} pricing is based on lawn size. Outline your lawn area to get an accurate quote.`;
                    } else if (serviceNames.length === 2) {
                        message = `Your ${serviceNames[0]} and ${serviceNames[1]} pricing are based on lawn size. Outline your lawn to get accurate quotes.`;
                    } else {
                        message = `Your ${serviceNames.slice(0, -1).join(', ')}, and ${serviceNames[serviceNames.length - 1]} pricing are based on lawn size. Outline your lawn area below.`;
                    }
                }
                bodyEl.textContent = message;
            }
            
            // Icon SVGs
            const icons = {
                grass: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 10V3"/><path d="m4 14 .94-3.06a1 1 0 0 1 .92-.69h.28a1 1 0 0 1 .92.69L8 14"/><path d="M4 14h4"/><path d="m16 14 .94-3.06a1 1 0 0 1 .92-.69h.28a1 1 0 0 1 .92.69L20 14"/><path d="M16 14h4"/><path d="M12 10c-1.5 0-3 .5-3 2v9"/><path d="M12 10c1.5 0 3 .5 3 2v9"/></svg>',
                dots: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',
                seed: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c4-4 8-8 8-12a8 8 0 1 0-16 0c0 4 4 8 8 12Z"/><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg>',
                leaf: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>',
                rake: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v2a2 2 0 0 1-2 2h-2l-2 12H10L8 8H6a2 2 0 0 1-2-2V4z"/><line x1="6" y1="4" x2="6" y2="8"/><line x1="10" y1="4" x2="10" y2="8"/><line x1="14" y1="4" x2="14" y2="8"/><line x1="18" y1="4" x2="18" y2="8"/></svg>',
                mulch: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>'
            };
            
            // Build HTML for service tags
            let html = '';
            services.forEach(service => {
                html += `
                    <div class="measurement-service-tag">
                        ${icons[service.icon] || ''}
                        ${service.name}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Check if any service is selected and show/hide conditional sections
        function updateConditionalSections() {
            const propertyCard = document.getElementById('propertyDetailsCard');
            const notesCard = document.getElementById('additionalNotesCard');
            
            // Check if ANY service is selected
            const hasDropdownService = Object.values(serviceSelections).some(v => v !== null);
            const hasSimpleService = Object.keys(selectedServices).length > 0;
            const hasWeedManService = typeof weedManServices !== 'undefined' && weedManServices.length > 0;
            
            const anyServiceSelected = hasDropdownService || hasSimpleService || hasWeedManService;
            
            if (anyServiceSelected) {
                // Show sections with animation
                propertyCard.style.display = 'block';
                notesCard.style.display = 'block';
                // Trigger reflow for animation
                void propertyCard.offsetWidth;
                propertyCard.classList.add('visible');
                notesCard.classList.add('visible');
            } else {
                // Hide sections
                propertyCard.classList.remove('visible');
                notesCard.classList.remove('visible');
                // Hide after animation
                setTimeout(() => {
                    if (!propertyCard.classList.contains('visible')) {
                        propertyCard.style.display = 'none';
                    }
                    if (!notesCard.classList.contains('visible')) {
                        notesCard.style.display = 'none';
                    }
                }, 300);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const biweeklyOption = document.getElementById('biweeklyOption');
            if (!isBiweeklyAvailable()) {
                biweeklyOption.classList.add('disabled');
            }
            
            // Initialize Google Places Autocomplete for address field
            initAddressAutocomplete();
        });
        
        // Google Places Autocomplete
        let addressAutocomplete = null;
        
        function initAddressAutocomplete() {
            const addressInput = document.getElementById('address');
            
            addressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                componentRestrictions: { country: 'us' },
                fields: ['formatted_address', 'geometry', 'address_components'],
                types: ['address']
            });
            
            // When user selects an address from dropdown
            addressAutocomplete.addListener('place_changed', function() {
                const place = addressAutocomplete.getPlace();
                
                if (place.formatted_address) {
                    addressInput.value = place.formatted_address;
                }
            });
            
            // Prevent form submission on Enter when autocomplete is open
            addressInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const pacContainer = document.querySelector('.pac-container');
                    if (pacContainer && pacContainer.style.display !== 'none') {
                        e.preventDefault();
                    }
                }
            });
        }
        
        // Generic dropdown toggle for services with sub-options
        function toggleServiceDropdown(serviceType) {
            const pillId = {
                mowing: 'pillMowing',
                fertilization: 'pillFertilization',
                mulch: 'pillMulch',
                bushTrimming: 'pillBushTrimming',
                aeration: 'pillAeration',
                overseeding: 'pillOverseeding',
                weedControl: 'pillWeedControl',
                yardCleanup: 'pillYardCleanup'
            }[serviceType];
            
            const dropdownId = serviceType + 'Dropdown';
            const pill = document.getElementById(pillId);
            const dropdown = document.getElementById(dropdownId);
            const container = document.querySelector('.container');
            
            // Close all other dropdowns first
            document.querySelectorAll('.service-dropdown.show').forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                container.classList.remove('dropdown-open');
                // For weedControl, check weedManServices instead of serviceSelections
                const hasSelection = serviceType === 'weedControl' ? weedManServices.length > 0 : serviceSelections[serviceType];
                if (!hasSelection) {
                    pill.classList.remove('selected');
                }
            } else {
                dropdown.classList.add('show');
                container.classList.add('dropdown-open');
                pill.classList.add('selected');
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdownTypes = ['mowing', 'fertilization', 'mulch', 'bushTrimming', 'aeration', 'overseeding', 'weedControl', 'yardCleanup'];
            const container = document.querySelector('.container');
            let anyDropdownOpen = false;
            
            dropdownTypes.forEach(type => {
                const dropdown = document.getElementById(type + 'Dropdown');
                const pillId = {
                    mowing: 'pillMowing',
                    fertilization: 'pillFertilization',
                    mulch: 'pillMulch',
                    bushTrimming: 'pillBushTrimming',
                    aeration: 'pillAeration',
                    overseeding: 'pillOverseeding',
                    weedControl: 'pillWeedControl',
                    yardCleanup: 'pillYardCleanup'
                }[type];
                const pill = document.getElementById(pillId);
                
                if (dropdown && pill) {
                    // Check if click was inside dropdown or on pill
                    const clickedInDropdown = dropdown.contains(e.target);
                    const clickedOnPill = pill.contains(e.target);
                    
                    if (!clickedInDropdown && !clickedOnPill && dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                        // For weedControl, check weedManServices instead of serviceSelections
                        const hasSelection = type === 'weedControl' ? weedManServices.length > 0 : serviceSelections[type];
                        if (!hasSelection) {
                            pill.classList.remove('selected');
                        }
                    }
                    
                    // Track if any dropdown is still open
                    if (dropdown.classList.contains('show')) {
                        anyDropdownOpen = true;
                    }
                }
            });
            
            // Remove dropdown-open class if no dropdowns are open
            if (!anyDropdownOpen) {
                container.classList.remove('dropdown-open');
            }
        });
        
        // Select option from dropdown (handles both select and deselect)
        // fromPackage: optional flag to indicate selection came from a package preset (don't clear selectedPackage)
        function selectServiceOption(serviceType, value, displayLabel, fromPackage = false) {
            // If manually selecting a service (not from package preset), mark package as edited
            if (!fromPackage && selectedPackage) {
                packageWasEdited = true;
            }
            const pillId = {
                mowing: 'pillMowing',
                fertilization: 'pillFertilization',
                mulch: 'pillMulch',
                bushTrimming: 'pillBushTrimming',
                aeration: 'pillAeration',
                overseeding: 'pillOverseeding',
                yardCleanup: 'pillYardCleanup'
            }[serviceType];
            
            const sublabelId = serviceType + 'Sublabel';
            const dropdownId = serviceType + 'Dropdown';
            
            const pill = document.getElementById(pillId);
            const sublabel = document.getElementById(sublabelId);
            const dropdown = document.getElementById(dropdownId);
            
            // Check for disabled options
            if (serviceType === 'mowing' && value === 'biweekly' && !isBiweeklyAvailable()) {
                return;
            }
            
            // If clicking on already selected option, deselect it
            if (serviceSelections[serviceType] === value) {
                // Deselect
                serviceSelections[serviceType] = null;
                const serviceKey = serviceType === 'bushTrimming' ? 'bush_trimming' : 
                                   serviceType === 'yardCleanup' ? 'yard_cleanup' : serviceType;
                delete selectedServices[serviceKey];
                
                // Update UI
                pill.classList.remove('selected');
                sublabel.textContent = '';
                sublabel.classList.remove('show');
                
                // Clear dropdown selection
                dropdown.querySelectorAll('.dropdown-option').forEach(o => o.classList.remove('selected'));
                
                // Handle mowing-specific state
                if (serviceType === 'mowing') {
                    mowingType = null;
                    document.getElementById('onetimeNote').classList.remove('show');
                }
            } else {
                // Select new option
                serviceSelections[serviceType] = value;
                
                // Update selectedServices based on type
                if (serviceType === 'mowing') {
                    mowingType = value;
                    selectedServices.mowing = value;
                    document.getElementById('onetimeNote').classList.toggle('show', value === 'onetime');
                } else if (serviceType === 'fertilization') {
                    fertilizationType = value;
                    selectedServices.fertilization = value;
                } else if (serviceType === 'mulch') {
                    mulchColor = value;
                    selectedServices.mulch = value;
                } else if (serviceType === 'bushTrimming') {
                    bushTrimmingFrequency = value;
                    selectedServices.bush_trimming = value;
                } else if (serviceType === 'aeration') {
                    aerationType = value;
                    selectedServices.aeration = value;
                } else if (serviceType === 'overseeding') {
                    overseedingType = value;
                    selectedServices.overseeding = value;
                } else if (serviceType === 'yardCleanup') {
                    selectedServices.yard_cleanup = value;
                }
                
                // Update dropdown styling
                dropdown.querySelectorAll('.dropdown-option').forEach(o => {
                    o.classList.toggle('selected', o.dataset.value === value);
                });
                
                // Update pill styling
                pill.classList.add('selected');
                sublabel.textContent = displayLabel;
                sublabel.classList.add('show');
            }
            
            // Close dropdown
            dropdown.classList.remove('show');
            
            // Blur pill to clear focus/hover state on mobile
            pill.blur();
            
            updatePhotoVisibility();
            checkGateWidth(); // Re-check gate width when services change
            updateMulchIndicator(); // Update mulch indicator when services change
            updateConditionalSections(); // Show/hide Property Details & Notes
        }
        
        // Update mulch indicator visibility and button highlight
        function updateMulchIndicator() {
            const mulchIndicator = document.getElementById('mulchIndicator');
            const mulchBtn = document.getElementById('btnMulch');
            
            const mulchSelected = selectedServices.mulch;
            const hasMulchAreas = totalMulchSqft > 0;
            const needsMulchMeasurement = mulchSelected && !hasMulchAreas;
            
            if (mulchIndicator) {
                mulchIndicator.style.display = needsMulchMeasurement ? 'flex' : 'none';
            }
            
            // Highlight the Mulch button in toolbar when measurement is needed
            if (mulchBtn) {
                if (needsMulchMeasurement) {
                    mulchBtn.classList.add('mulch-needs-attention');
                } else {
                    mulchBtn.classList.remove('mulch-needs-attention');
                }
            }
        }
        
        // Legacy mowing dropdown function (for backward compatibility)
        function toggleMowingDropdown() {
            toggleServiceDropdown('mowing');
        }
        
        // Legacy mowing type selector
        function selectMowingType(type) {
            const labels = {
                weekly: 'Weekly Mowing',
                biweekly: 'Bi-Weekly',
                onetime: 'One-Time Mow'
            };
            selectServiceOption('mowing', type, labels[type]);
        }
        
        // Simple toggle for services without sub-options
        function toggleSimpleService(btn) {
            // If manually toggling a service, mark package as edited
            if (selectedPackage) {
                packageWasEdited = true;
            }
            
            const service = btn.dataset.service;
            btn.classList.toggle('selected');
            
            if (btn.classList.contains('selected')) {
                selectedServices[service] = true;
            } else {
                delete selectedServices[service];
            }
            
            // Blur to clear focus/hover state on mobile
            btn.blur();
            
            updatePhotoVisibility();
            checkGateWidth(); // Re-check gate width when services change
            updateMulchIndicator(); // Update mulch indicator when services change
            updateConditionalSections(); // Show/hide Property Details & Notes
        }
        
        // Weed Man Partner Services Multi-Select
        let weedManServices = [];
        
        function toggleWeedManDropdown() {
            const dropdown = document.getElementById('weedControlDropdown');
            const pill = document.getElementById('pillWeedControl');
            const container = document.querySelector('.container');
            
            // Close other dropdowns first
            document.querySelectorAll('.service-dropdown').forEach(d => {
                if (d.id !== 'weedControlDropdown') d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
            
            // Toggle container class to prevent scrollbars
            if (dropdown.classList.contains('show')) {
                container.classList.add('dropdown-open');
            } else {
                container.classList.remove('dropdown-open');
            }
        }
        
        function updateWeedManSelection(fromPackage = false) {
            // If manually changing weed services (not from package preset), mark package as edited
            if (!fromPackage && selectedPackage) {
                packageWasEdited = true;
            }
            
            const dropdown = document.getElementById('weedControlDropdown');
            const pill = document.getElementById('pillWeedControl');
            const sublabel = document.getElementById('weedControlSublabel');
            
            // Get all checked services
            weedManServices = [];
            dropdown.querySelectorAll('.weedman-option input[type="checkbox"]:checked').forEach(checkbox => {
                weedManServices.push(checkbox.closest('.weedman-option').dataset.value);
            });
            
            // Update pill styling and sublabel
            if (weedManServices.length > 0) {
                pill.classList.add('selected');
                selectedServices.weed_control = weedManServices;
                
                // Show count or short name (avoid redundancy with pill-desc)
                if (weedManServices.length === 1) {
                    const names = {
                        'weed_control_fertilizer': 'Every 4-6 Weeks',
                        'insect_control': 'Insect Control',
                        'crabgrass_control': 'Crabgrass',
                        'mosquito_control': 'Mosquito',
                        'grub_control': 'Grub Control',
                        'perimeter_pest': 'Perimeter Pest'
                    };
                    sublabel.textContent = names[weedManServices[0]] || weedManServices[0];
                } else {
                    sublabel.textContent = `${weedManServices.length} services`;
                }
                sublabel.classList.add('show');
                
                // Note: We don't show Fertilization as "included" anymore - WC+Fert handles it
            } else {
                pill.classList.remove('selected');
                delete selectedServices.weed_control;
                sublabel.textContent = '';
                sublabel.classList.remove('show');
            }
            
            updatePhotoVisibility();
            checkGateWidth();
            updateMulchIndicator();
            updateConditionalSections(); // Show/hide Property Details & Notes
        }
        
        function closeWeedManDropdown() {
            const dropdown = document.getElementById('weedControlDropdown');
            const pill = document.getElementById('pillWeedControl');
            const container = document.querySelector('.container');
            dropdown.classList.remove('show');
            container.classList.remove('dropdown-open');
            pill.blur();
        }
        
        // Weed Man payment preference (prepay vs per service)
        function updateWeedManPayment() {
            // Update toggle button styling
            document.querySelectorAll('input[name="weedManPayment"]').forEach(radio => {
                const toggleBtn = radio.nextElementSibling;
                if (radio.checked) {
                    toggleBtn.style.background = 'white';
                    toggleBtn.style.color = '#111827';
                    toggleBtn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                } else {
                    toggleBtn.style.background = 'transparent';
                    toggleBtn.style.color = '#6b7280';
                    toggleBtn.style.boxShadow = 'none';
                }
            });
        }
        
        // Legacy wrapper for package presets
        function selectWeedControlOption(value, label) {
            const dropdown = document.getElementById('weedControlDropdown');
            
            // Map old values to new checkbox values
            const valueMap = {
                'combo': 'weed_control_fertilizer'
            };
            
            const checkboxValue = valueMap[value] || value;
            const checkbox = dropdown.querySelector(`.weedman-option[data-value="${checkboxValue}"] input[type="checkbox"]`);
            
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                updateWeedManSelection(true); // fromPackage=true since this is called by packages
            }
        }
        
        // Package hover highlight - shows which services are included
        // Note: Fertilization is NOT included separately - it's part of Weed Control + Fertilizer combo
        const packageServiceMap = {
            essential: ['pillMowing', 'pillAeration', 'pillOverseeding', 'pillWeedControl'],
            complete: ['pillMowing', 'pillAeration', 'pillOverseeding', 'pillWeedControl', 'pillBushTrimming', 'power_raking'],
            total: ['pillMowing', 'pillAeration', 'pillOverseeding', 'pillWeedControl', 'pillMulch', 'pillBushTrimming', 'pillYardCleanup', 'power_raking']
        };
        
        function highlightPackageServices(packageType) {
            const services = packageServiceMap[packageType];
            if (!services) return;
            
            services.forEach(id => {
                // Try by ID first (dropdown services)
                let pill = document.getElementById(id);
                // If not found, try by data-service attribute (simple services)
                if (!pill) {
                    pill = document.querySelector(`[data-service="${id}"]`);
                }
                if (pill) {
                    pill.classList.add('package-highlight');
                }
            });
        }
        
        function unhighlightPackageServices() {
            document.querySelectorAll('.service-pill.package-highlight').forEach(pill => {
                pill.classList.remove('package-highlight');
            });
        }
        
        // Package quick-select (with toggle behavior)
        function selectPackage(packageType) {
            const clickedBtn = event.target.closest('.package-btn');
            const wasSelected = clickedBtn.classList.contains('selected');
            
            // Clear all current selections first
            clearAllServices();
            
            // Remove 'selected' from all package buttons
            document.querySelectorAll('.package-btn').forEach(btn => btn.classList.remove('selected'));
            
            // If this package was already selected, just deselect (toggle off)
            if (wasSelected) {
                selectedPackage = null; // Clear package selection
                // Clear any lingering package-highlight classes from services
                unhighlightPackageServices();
                updatePhotoVisibility();
                checkGateWidth();
                updateMulchIndicator();
                updateConditionalSections();
                return;
            }
            
            // Otherwise, select this package
            clickedBtn.classList.add('selected');
            selectedPackage = packageType; // Track which package was selected
            packageWasEdited = false; // Reset edited flag when selecting a new package
            
            // Select services based on package (pass fromPackage=true to preserve package tracking)
            if (packageType === 'essential') {
                // Essentials: Weekly mowing, aeration, overseeding, Weed Control + Fertilizer
                selectServiceOption('mowing', 'weekly', 'Weekly Mowing', true);
                selectServiceOption('aeration', 'single', 'Single Pass', true);
                selectServiceOption('overseeding', 'standard', 'Standard', true);
                selectWeedControlOption('combo', 'Weed Control + Fertilizer');
            } else if (packageType === 'complete') {
                // Complete: Weekly mowing, aeration, overseeding, Weed Control + Fertilizer, 
                // Bush trimming (every 2 months), Power Raking
                selectServiceOption('mowing', 'weekly', 'Weekly Mowing', true);
                selectServiceOption('aeration', 'single', 'Single Pass', true);
                selectServiceOption('overseeding', 'standard', 'Standard', true);
                selectWeedControlOption('combo', 'Weed Control + Fertilizer');
                selectServiceOption('bushTrimming', 'bimonthly', 'Every 2 Months', true);
                // Select power raking
                const powerRakingBtn = document.querySelector('[data-service="power_raking"]');
                if (powerRakingBtn && !powerRakingBtn.classList.contains('selected')) {
                    powerRakingBtn.classList.add('selected');
                    selectedServices.power_raking = true;
                }
            } else if (packageType === 'total') {
                // Premium: All services EXCEPT standalone Fertilizer (to avoid double with Weed Control + Fert)
                // Users should customize: Mulch, Bush Trimming, Weed Control options
                selectServiceOption('mowing', 'weekly', 'Weekly Mowing', true);
                selectServiceOption('aeration', 'double', 'Double Pass', true);
                selectServiceOption('overseeding', 'complete', 'Complete Package', true);
                selectWeedControlOption('combo', 'Weed Control + Fertilizer');
                // Note: DO NOT select standalone Fertilization (would duplicate Weed Control + Fertilizer)
                selectServiceOption('mulch', 'brown', 'Brown', true); // Default to brown, user can change
                selectServiceOption('bushTrimming', 'bimonthly', 'Every 2 Months', true);
                selectServiceOption('yardCleanup', 'complete_cleanup', 'Complete Yard Cleanup', true);
                // Select power raking
                const powerRakingBtn = document.querySelector('[data-service="power_raking"]');
                if (powerRakingBtn && !powerRakingBtn.classList.contains('selected')) {
                    powerRakingBtn.classList.add('selected');
                    selectedServices.power_raking = true;
                }
                // Show premium warning about customization
                showPremiumCustomizeHint();
            }
            
            updatePhotoVisibility();
            checkGateWidth();
            updateMulchIndicator();
            updateConditionalSections(); // Show/hide Property Details & Notes
        }
        
        // Show the package configuration modal for VIP package
        function showPackageConfigModal() {
            // Reset modal to defaults
            document.getElementById('packageMulchColor').value = '';
            document.getElementById('packageBushFrequency').value = 'bimonthly';
            
            // Reset weed service checkboxes - only weed_control_fertilizer checked by default
            document.querySelectorAll('#packageWeedServices input[type="checkbox"]').forEach(cb => {
                const value = cb.closest('.package-accordion-item').dataset.value;
                cb.checked = (value === 'weed_control_fertilizer');
            });
            
            // Update count and close accordion by default
            updateWeedCount();
            document.getElementById('weedServicesAccordion').classList.remove('open');
            
            // Show modal
            document.getElementById('packageConfigModal').classList.add('show');
        }
        
        // Toggle weed services accordion
        function toggleWeedAccordion(event) {
            // Don't toggle if clicking on a checkbox or label
            if (event.target.type === 'checkbox' || event.target.closest('.package-accordion-item')) {
                return;
            }
            document.getElementById('weedServicesAccordion').classList.toggle('open');
        }
        
        // Update weed services count badge
        function updateWeedCount() {
            const count = document.querySelectorAll('#packageWeedServices input[type="checkbox"]:checked').length;
            const countEl = document.getElementById('weedServicesCount');
            countEl.textContent = count === 1 ? '1 selected' : `${count} selected`;
        }
        
        // Cancel package config - deselect the package button
        function cancelPackageConfig() {
            document.getElementById('packageConfigModal').classList.remove('show');
            // Remove 'selected' from Total Care button since they cancelled
            document.querySelectorAll('.package-btn').forEach(btn => btn.classList.remove('selected'));
        }
        
        // Apply the package configuration
        function applyPackageConfig() {
            // Get selected values
            const mulchColor = document.getElementById('packageMulchColor').value;
            const bushFrequency = document.getElementById('packageBushFrequency').value;
            const selectedWeedServices = [];
            
            document.querySelectorAll('#packageWeedServices input[type="checkbox"]:checked').forEach(cb => {
                selectedWeedServices.push(cb.closest('.package-accordion-item').dataset.value);
            });
            
            // Close modal
            document.getElementById('packageConfigModal').classList.remove('show');
            
            // Apply Total Care base services (fromPackage=true to preserve package tracking)
            selectServiceOption('mowing', 'weekly', 'Weekly Mowing', true);
            selectServiceOption('aeration', 'double', 'Double Pass', true);
            selectServiceOption('overseeding', 'complete', 'Complete Package', true);
            
            // Apply mulch color if selected
            if (mulchColor) {
                const colorLabels = { brown: 'Brown', black: 'Black', red: 'Red' };
                selectServiceOption('mulch', mulchColor, colorLabels[mulchColor], true);
            }
            
            // Apply weed services via the Weed Man dropdown
            if (selectedWeedServices.length > 0) {
                // Clear existing Weed Man selections
                const weedDropdown = document.getElementById('weedControlDropdown');
                if (weedDropdown) {
                    weedDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                }
                
                // Check the selected services in the actual weed control dropdown
                selectedWeedServices.forEach(service => {
                    const checkbox = document.querySelector(`#weedControlDropdown .weedman-option[data-value="${service}"] input[type="checkbox"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                // Update the weed man selection state
                updateWeedManSelection(true); // fromPackage=true since this is in applyPackageConfig
            }
            
            // Apply bush trimming frequency if selected (fromPackage=true)
            if (bushFrequency) {
                const freqLabels = { 
                    monthly: 'Once a Month', 
                    bimonthly: 'Every 2 Months', 
                    quarterly: 'Every 3 Months' 
                };
                selectServiceOption('bushTrimming', bushFrequency, freqLabels[bushFrequency], true);
            }
            
            // Select leaf cleanup
            const leafBtn = document.querySelector('[data-service="leaf_cleanup"]');
            if (leafBtn && !leafBtn.classList.contains('selected')) {
                leafBtn.classList.add('selected');
                selectedServices.leaf_cleanup = true;
            }
            
            // Select yard cleanup
            const yardBtn = document.querySelector('[data-service="yard_cleanup"]');
            if (yardBtn && !yardBtn.classList.contains('selected')) {
                yardBtn.classList.add('selected');
                selectedServices.yard_cleanup = true;
            }
            
            updatePhotoVisibility();
            checkGateWidth();
            updateMulchIndicator();
            updateConditionalSections(); // Show/hide Property Details & Notes
        }
        
        // Show hint for Premium package customization
        function showPremiumCustomizeHint() {
            // Flash the services that can be customized briefly
            const customizableServices = ['pillMulch', 'pillBushTrimming', 'pillWeedControl'];
            customizableServices.forEach(id => {
                const pill = document.getElementById(id);
                if (pill) {
                    pill.classList.add('premium-customize-hint');
                    setTimeout(() => {
                        pill.classList.remove('premium-customize-hint');
                    }, 3000);
                }
            });
        }
        
        // Clear all selected services
        function clearAllServices() {
            // Clear dropdown services
            ['mowing', 'fertilization', 'mulch', 'bushTrimming', 'aeration', 'overseeding', 'yardCleanup'].forEach(type => {
                serviceSelections[type] = null;
                const pillId = {
                    mowing: 'pillMowing',
                    fertilization: 'pillFertilization',
                    mulch: 'pillMulch',
                    bushTrimming: 'pillBushTrimming',
                    aeration: 'pillAeration',
                    overseeding: 'pillOverseeding',
                    yardCleanup: 'pillYardCleanup'
                }[type];
                const pill = document.getElementById(pillId);
                const sublabel = document.getElementById(type + 'Sublabel');
                const dropdown = document.getElementById(type + 'Dropdown');
                
                if (pill) pill.classList.remove('selected');
                if (sublabel) {
                    sublabel.textContent = '';
                    sublabel.classList.remove('show');
                }
                if (dropdown) {
                    dropdown.querySelectorAll('.dropdown-option').forEach(o => o.classList.remove('selected'));
                }
            });
            
            // Clear simple toggle services
            document.querySelectorAll('.service-pill[data-service]').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Clear weed control dropdown
            const weedControlPill = document.getElementById('pillWeedControl');
            if (weedControlPill) {
                weedControlPill.classList.remove('selected');
                const sublabel = document.getElementById('weedControlSublabel');
                if (sublabel) {
                    sublabel.textContent = '';
                    sublabel.classList.remove('show');
                }
                const dropdown = document.getElementById('weedControlDropdown');
                if (dropdown) {
                    dropdown.querySelectorAll('.dropdown-option').forEach(o => o.classList.remove('selected'));
                }
            }
            
            // Reset state
            selectedServices = {};
            mowingType = null;
            fertilizationType = null;
            mulchColor = null;
            bushTrimmingFrequency = null;
            aerationType = null;
            overseedingType = null;
            weedManServices = [];
            
            // Clear Weed Man checkboxes
            const weedDropdown = document.getElementById('weedControlDropdown');
            if (weedDropdown) {
                weedDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
            
            // Hide one-time note
            document.getElementById('onetimeNote').classList.remove('show');
            
            // Clear any package highlight styling from service pills
            unhighlightPackageServices();
            
            // Hide conditional sections
            updateConditionalSections();
        }
        
        // Property question handlers
        function setGate(hasIt) {
            hasGate = hasIt;
            document.getElementById('gateNo').classList.toggle('selected', !hasIt);
            document.getElementById('gateYes').classList.toggle('selected', hasIt);
            document.getElementById('gateDetails').classList.toggle('show', hasIt);
            
            if (!hasIt) {
                gateWidth = null;
                gateCode = null;
                document.getElementById('gateWidth').value = '';
                document.getElementById('gateCode').value = '';
                document.getElementById('gateWarning').classList.remove('show');
            }
        }
        
        // Sync gate slider and input bidirectionally
        function syncGateFromSlider(value) {
            const numValue = parseInt(value) || 0;
            document.getElementById('gateWidth').value = numValue;
            document.getElementById('gateLiveValue').textContent = numValue + '"';
            checkGateWidth();
        }
        
        function syncGateFromInput(value) {
            const numValue = parseInt(value) || 0;
            const slider = document.getElementById('gateSlider');
            // Clamp to slider range (0-100) for visual, but allow higher values in input
            slider.value = Math.min(Math.max(numValue, 0), 100);
            document.getElementById('gateLiveValue').textContent = numValue + '"';
            checkGateWidth();
        }
        
        function checkGateWidth() {
            const width = parseInt(document.getElementById('gateWidth').value);
            gateWidth = width || null;
            
            const warningMowingEl = document.getElementById('gateWarning');
            const warningCleanupEl = document.getElementById('gateWarningCleanup');
            const successEl = document.getElementById('gateSuccess');
            
            // Hide all messages first
            warningMowingEl.classList.remove('show');
            warningCleanupEl.classList.remove('show');
            successEl.classList.remove('show');
            
            if (!width) {
                // No width entered yet
                return;
            }
            
            // Check which services are selected
            const needsWideGate = selectedServices.mowing || selectedServices.aeration; // Needs 32"
            const needsCleanupGate = selectedServices.yardCleanup || selectedServices.leafRemoval; // Needs 25"
            
            // Determine minimum required width based on selected services
            let minRequired = 0;
            if (needsWideGate) {
                minRequired = 32;
            } else if (needsCleanupGate) {
                minRequired = 25;
            }
            
            if (needsWideGate && width < 32) {
                // Gate too narrow for mowing/aeration (need 32")
                warningMowingEl.classList.add('show');
            } else if (!needsWideGate && needsCleanupGate && width < 25) {
                // Gate too narrow for cleanup (need 25") - only show if mowing/aeration NOT selected
                warningCleanupEl.classList.add('show');
            } else if (width >= minRequired && minRequired > 0) {
                // Gate is wide enough for selected services
                successEl.classList.add('show');
            }
            // If no relevant services selected, show nothing (fertilizer, etc don't need gate access)
        }
        
        // Gate code is now always visible when gate is selected (optional field)
        
        function setDog(hasIt) {
            hasDog = hasIt;
            document.getElementById('dogNo').classList.toggle('selected', !hasIt);
            document.getElementById('dogYes').classList.toggle('selected', hasIt);
            document.getElementById('dogWarning').classList.toggle('show', hasIt);
            
            if (!hasIt) {
                dogConfirmed = false;
                document.getElementById('dogConfirm').checked = false;
            }
        }
        
        function updateDogConfirm() {
            dogConfirmed = document.getElementById('dogConfirm').checked;
        }
        
        function updateSubmitButton() {
            // No longer needed - validation happens in goToStep3
        }
        
        function setOvergrown(isIt) {
            isOvergrown = isIt;
            document.getElementById('overgrownNo').classList.toggle('selected', !isIt);
            document.getElementById('overgrownYes').classList.toggle('selected', isIt);
            document.getElementById('overgrownDetails').classList.toggle('show', isIt);
            
            if (!isIt) {
                grassHeight = null;
                document.getElementById('grassHeight').value = '';
            }
            
            updatePhotoVisibility();
        }
        
        function setStairs(hasIt) {
            hasStairs = hasIt;
            document.getElementById('stairsNo').classList.toggle('selected', !hasIt);
            document.getElementById('stairsYes').classList.toggle('selected', hasIt);
        }
        
        // Track photo section state
        let photoSectionEnabled = true; // Photos toggle is ON by default
        let photoSkipConfirmed = false; // Has user confirmed skipping photos?
        
        // Update photo section visibility
        // Show photos ONLY for: One-time mow, Mulch install, Yard cleanup, Bush trimming, Power Raking
        // Also show if lawn is overgrown AND mowing is selected (any frequency)
        // NEVER show for: Weekly/bi-weekly mowing (unless overgrown), aeration, overseeding, fertilizer, weed control
        function updatePhotoVisibility() {
            const needsPhotos = 
                mowingType === 'onetime' || 
                selectedServices.yard_cleanup || // Now a dropdown with leaf_cleanup or complete_cleanup
                selectedServices.mulch ||
                selectedServices.bush_trimming ||
                selectedServices.power_raking ||
                (isOvergrown && (mowingType === 'weekly' || mowingType === 'biweekly'));
            
            document.getElementById('photoSection').classList.toggle('show', needsPhotos);
            
            // Reset photo state when visibility changes
            if (needsPhotos) {
                // Reset to enabled when section becomes visible
                photoSectionEnabled = true;
                photoSkipConfirmed = false;
                updatePhotoToggleUI();
            }
        }
        
        // Update photo toggle UI
        function updatePhotoToggleUI() {
            const toggle = document.getElementById('photoToggle');
            const content = document.getElementById('photoContent');
            
            if (photoSectionEnabled) {
                toggle.classList.remove('off');
                content.classList.remove('hidden');
            } else {
                toggle.classList.add('off');
                content.classList.add('hidden');
            }
            // Trigger height update after toggle
            setTimeout(triggerHeightUpdate, 50);
        }
        
        // Toggle photo section (user clicks the toggle)
        function togglePhotoSection() {
            if (photoSectionEnabled) {
                // User wants to turn OFF photos - show confirmation modal
                document.getElementById('photoSkipModal').classList.add('show');
            } else {
                // User wants to turn ON photos - just enable
                photoSectionEnabled = true;
                photoSkipConfirmed = false;
                updatePhotoToggleUI();
            }
        }
        
        // User clicked "Add Photos" in modal - cancel the skip
        function cancelPhotoSkip() {
            document.getElementById('photoSkipModal').classList.remove('show');
            // Keep photos enabled
        }
        
        // User clicked "Continue Without Photos" in modal - confirm skip
        function confirmPhotoSkip() {
            document.getElementById('photoSkipModal').classList.remove('show');
            photoSectionEnabled = false;
            photoSkipConfirmed = true;
            updatePhotoToggleUI();
        }
        
        // Prevent event bubbling on dropdown clicks
        document.querySelectorAll('.service-dropdown').forEach(dropdown => {
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
        
        // Photo handling - max 10 photos
        const MAX_PHOTOS = 10;
        
        function handlePhotos(files) {
            const remaining = MAX_PHOTOS - photos.length;
            if (remaining <= 0) {
                alert('Maximum 10 photos allowed. Please remove some photos before adding more.');
                return;
            }
            
            let added = 0;
            for (const file of files) {
                if (added >= remaining) {
                    alert(`Only ${remaining} more photo(s) can be added. Maximum is 10 photos.`);
                    break;
                }
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photos.push({ name: file.name, data: e.target.result, file });
                        renderPhotos();
                        updatePhotoCount();
                    };
                    reader.readAsDataURL(file);
                    added++;
                }
            }
        }
        
        function renderPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = photos.map((p, i) => `
                <div class="photo-item">
                    <img src="${p.data}" alt="${p.name}" onload="triggerHeightUpdate()">
                    <button type="button" class="photo-remove" onclick="removePhoto(${i})">Ã—</button>
                </div>
            `).join('');
            // Trigger height update after DOM change
            triggerHeightUpdate();
        }
        
        // Global function to trigger iframe height update
        function triggerHeightUpdate() {
            const height = document.body.scrollHeight;
            window.parent.postMessage({ type: 'nmw-widget-height', height: height }, '*');
        }
        
        function updatePhotoCount() {
            const countEl = document.getElementById('photoCount');
            if (photos.length === 0) {
                countEl.textContent = '';
                countEl.classList.remove('at-limit');
            } else if (photos.length >= MAX_PHOTOS) {
                countEl.textContent = `${photos.length}/${MAX_PHOTOS} photos (maximum reached)`;
                countEl.classList.add('at-limit');
            } else {
                countEl.textContent = `${photos.length}/${MAX_PHOTOS} photos`;
                countEl.classList.remove('at-limit');
            }
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            renderPhotos();
            updatePhotoCount();
        }
        
        // Click outside polygons to deselect them
        document.addEventListener('click', function(e) {
            // Only deselect if clicking on map toolbar, map instructions, or map result areas
            const mapToolbar = document.querySelector('.map-toolbar');
            const mapInstructions = document.querySelector('.map-instructions');
            const mapResult = document.getElementById('mapResult');
            const mulchCalculator = document.getElementById('mulchCalculator');
            
            if ((mapToolbar && mapToolbar.contains(e.target)) ||
                (mapInstructions && mapInstructions.contains(e.target)) ||
                (mapResult && mapResult.contains(e.target)) ||
                (mulchCalculator && mulchCalculator.contains(e.target))) {
                deselectAllPolygons();
            }
        });
        
        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handlePhotos(e.dataTransfer.files);
            });
        }
        
        // Navigation
        function goToStep1() {
            showScreen('screen1');
            updateSteps(1);
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('screen1').scrollIntoView({ behavior: 'instant', block: 'start' });
        }
        
        function goToStep2() {
            // Validate
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            
            if (!name || !email || !phone || !address) {
                alert('Please fill in all contact information.');
                return;
            }
            
            // Validate "How'd you find us?" dropdown (required)
            const referralSource = document.getElementById('referralSource').value;
            if (!referralSource) {
                alert('Please select how you found us.');
                return;
            }
            
            // Validate SMS consent (required before continuing)
            const smsConsent = document.getElementById('smsConsent').checked;
            if (!smsConsent) {
                alert('Please agree to receive texts and emails from No Mow Worries to continue.');
                return;
            }
            
            if (Object.keys(selectedServices).length === 0) {
                alert('Please select at least one service.');
                return;
            }
            
            // Validate Property Details questions (all required)
            if (hasGate === null) {
                alert('Please answer: Do you have a gate?');
                return;
            }
            if (hasDog === null) {
                alert('Please answer: Do you have dog(s)?');
                return;
            }
            if (isOvergrown === null) {
                alert('Please answer: Is your lawn overgrown?');
                return;
            }
            if (hasStairs === null) {
                alert('Please answer: Are there stairs to the backyard?');
                return;
            }
            
            // If mowing pill is selected but no type chosen
            if (document.getElementById('pillMowing').classList.contains('selected') && !mowingType) {
                alert('Please select a mowing frequency (Weekly, Bi-Weekly, or One-Time).');
                return;
            }
            
            // Check dog confirmation
            if (hasDog && !dogConfirmed) {
                alert('Please confirm that you understand the dog policy by checking the confirmation box.');
                return;
            }
            
            // Check photo requirements for services that need them
            // Must match the logic in updatePhotoVisibility()
            const photoServicesSelected = 
                mowingType === 'onetime' || 
                selectedServices.yard_cleanup || // Now a dropdown
                selectedServices.mulch ||
                selectedServices.bush_trimming ||
                selectedServices.power_raking ||
                (isOvergrown && (mowingType === 'weekly' || mowingType === 'biweekly'));
            
            if (photoServicesSelected && photoSectionEnabled && photos.length === 0) {
                // Photos section is on but no photos uploaded - require photos
                alert('Please upload at least one photo of your lawn before continuing. Photos help us provide accurate quotes.');
                return;
            }
            
            // Determine if any measurement-requiring services are selected
            // Note: weed_control does NOT require sqft measurement (handled by Weed Man)
            const needsLawnSqft = selectedServices.mowing || 
                                   selectedServices.aeration || 
                                   selectedServices.overseeding || 
                                   selectedServices.fertilization;
            
            const needsMulchMeasurement = selectedServices.mulch;
            
            // If no measurement needed, skip directly to step 3
            if (!needsLawnSqft && !needsMulchMeasurement) {
                measurementSkipped = true;
                goToStep3();
                return;
            }
            
            measurementSkipped = false;
            
            showScreen('screen2');
            updateSteps(2);
            
            // Scroll to top of the page so customer sees the measurement notice first
            window.scrollTo({ top: 0, behavior: 'instant' });
            // Also scroll widget container and screen into view
            document.getElementById('screen2').scrollIntoView({ behavior: 'instant', block: 'start' });
            document.querySelector('.widget-container')?.scrollTo({ top: 0, behavior: 'instant' });
            
            // Populate the sqft-based services list
            populateSqftServicesList();
            
            initMap();
            
            // Mulch-only mode: only mulch selected, no lawn services
            const mulchOnlyMode = needsMulchMeasurement && !needsLawnSqft;
            
            // Show/hide lawn button based on whether lawn services are selected
            const btnLawn = document.getElementById('btnLawn');
            if (btnLawn) {
                btnLawn.style.display = needsLawnSqft ? 'inline-flex' : 'none';
            }
            
            // Show/hide mulch button based on whether mulch is selected
            const btnMulch = document.getElementById('btnMulch');
            if (btnMulch) {
                btnMulch.style.display = needsMulchMeasurement ? 'inline-flex' : 'none';
            }
            
            // Update instructions text and set default mode
            const mapInstructions = document.querySelector('.map-instructions');
            if (mulchOnlyMode) {
                // Mulch-only: default to mulch mode
                if (mapInstructions) {
                    mapInstructions.innerHTML = '<strong>Outline your mulch beds</strong> â€” Tap points around each bed to measure square footage';
                }
                setDrawMode('mulch');
            } else if (needsLawnSqft && needsMulchMeasurement) {
                // Both lawn and mulch
                if (mapInstructions) {
                    mapInstructions.innerHTML = '<strong>Outline your lawn area</strong> â€” Then draw your mulch beds';
                }
                setDrawMode('lawn');
            } else {
                // Lawn only
                if (mapInstructions) {
                    mapInstructions.innerHTML = '<strong>Outline your lawn area</strong> â€” Tap points around your lawn to measure square footage';
                }
                setDrawMode('lawn');
            }
        }
        
        function goToStep3() {
            // Validate measurements if required
            // Note: weed_control does NOT require sqft measurement
            const needsLawnSqft = selectedServices.mowing || 
                                   selectedServices.aeration || 
                                   selectedServices.overseeding || 
                                   selectedServices.fertilization;
            const needsMulchMeasurement = selectedServices.mulch;
            
            if ((needsLawnSqft || needsMulchMeasurement) && !measurementSkipped) {
                const hasAnyMeasurement = areas.filter(a => a.type === 'lawn').length > 0 || areas.filter(a => a.type === 'mulch').length > 0;
                if (!hasAnyMeasurement) {
                    alert('Please draw at least one measurement area on the map before continuing.');
                    return;
                }
            }
            
            // Validate photos if photo section is enabled and visible
            const photoSectionVisible = document.getElementById('photoSection').classList.contains('show');
            if (photoSectionVisible && photoSectionEnabled && photos.length === 0) {
                alert('Please upload at least one photo, or turn off the photo toggle to continue without photos.');
                return;
            }
            
            // Validate SMS consent
            const smsConsent = document.getElementById('smsConsent').checked;
            if (!smsConsent) {
                alert('Please agree to receive texts and emails from No Mow Worries to continue.');
                return;
            }
            
            showScreen('screen3');
            updateSteps(3);
            updateSummary();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('screen3').scrollIntoView({ behavior: 'instant', block: 'start' });
            
            // Submit button is always enabled on step 3 (validations passed to get here)
            document.getElementById('submitBtn').disabled = false;
            
            // Add tooltip hover listeners
            const submitBtn = document.getElementById('submitBtn');
            const tooltip = document.getElementById('submitTooltip');
            submitBtn.addEventListener('mouseenter', () => tooltip.style.display = 'block');
            submitBtn.addEventListener('mouseleave', () => tooltip.style.display = 'none');
        }
        
        function goBackFromStep3() {
            // If measurement was skipped, go back to step 1
            if (measurementSkipped) {
                goToStep1();
            } else {
                goToStep2();
            }
        }
        
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function updateSteps(current) {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById('step' + i);
                step.classList.remove('active', 'done');
                if (i < current) step.classList.add('done');
                if (i === current) step.classList.add('active');
            }
        }
        
        function updateSummary() {
            document.getElementById('summaryName').textContent = document.getElementById('name').value;
            document.getElementById('summaryEmail').textContent = document.getElementById('email').value;
            document.getElementById('summaryPhone').textContent = document.getElementById('phone').value;
            document.getElementById('summaryAddress').textContent = document.getElementById('address').value;
            
            // Package (show if a package was selected, hide if custom/individual services)
            const packageRow = document.getElementById('packageRow');
            const packageEl = document.getElementById('summaryPackage');
            if (selectedPackage) {
                const packageNames = {
                    essential: 'Essentials',
                    complete: 'Complete',
                    total: 'Premium (VIP)'
                };
                packageRow.style.display = 'flex';
                packageEl.textContent = packageNames[selectedPackage] || 'Custom';
            } else {
                packageRow.style.display = 'none';
            }
            
            // Services
            const serviceLabels = {
                mowing: {
                    weekly: 'Weekly Mowing',
                    biweekly: 'Bi-Weekly Mowing',
                    onetime: 'One-Time Mow'
                },
                aeration: {
                    single: 'Lawn Aeration (Single Pass)',
                    double: 'Lawn Aeration (Double Pass)'
                },
                overseeding: {
                    standard: 'Overseeding',
                    complete: 'Overseeding + Peat Moss + Starter Fertilizer'
                },
                fertilization: {
                    onetime: 'Fertilization (One-Time)',
                    recurring: 'Fertilization (Every 4-6 Weeks)'
                },
                weed_control: {
                    combo: 'Weed Control + Fertilizer (via Weed Man)',
                    fertilizer_only: 'Fertilizer Only (via Weed Man)'
                },
                mulch: {
                    brown: 'Mulch Install (Brown)',
                    red: 'Mulch Install (Red)',
                    black: 'Mulch Install (Black)'
                },
                yard_cleanup: {
                    leaf_cleanup: 'Leaf Cleanup',
                    complete_cleanup: 'Complete Yard Cleanup'
                },
                power_raking: 'Power Raking',
                bush_trimming: {
                    onetime: 'Bush Trimming (One-Time)',
                    weekly: 'Bush Trimming (Weekly)',
                    monthly: 'Bush Trimming (Monthly)',
                    bimonthly: 'Bush Trimming (Every 2 Months)',
                    quarterly: 'Bush Trimming (Every 3 Months)'
                }
            };
            
            // Build NMW services list (exclude weed_control - that's Weed Man)
            const services = [];
            for (const [key, value] of Object.entries(selectedServices)) {
                // Skip weed_control - it goes in Weed Man section
                if (key === 'weed_control') continue;
                
                if (key === 'mowing' && typeof serviceLabels.mowing === 'object') {
                    services.push(serviceLabels.mowing[value]);
                } else if (key === 'aeration' && typeof serviceLabels.aeration === 'object') {
                    services.push(serviceLabels.aeration[value]);
                } else if (key === 'overseeding' && typeof serviceLabels.overseeding === 'object') {
                    services.push(serviceLabels.overseeding[value]);
                } else if (key === 'fertilization' && typeof serviceLabels.fertilization === 'object') {
                    services.push(serviceLabels.fertilization[value]);
                } else if (key === 'mulch' && typeof serviceLabels.mulch === 'object') {
                    services.push(serviceLabels.mulch[value]);
                } else if (key === 'bush_trimming' && typeof serviceLabels.bush_trimming === 'object') {
                    services.push(serviceLabels.bush_trimming[value]);
                } else if (key === 'yard_cleanup' && typeof serviceLabels.yard_cleanup === 'object') {
                    services.push(serviceLabels.yard_cleanup[value]);
                } else if (typeof serviceLabels[key] === 'string') {
                    services.push(serviceLabels[key]);
                }
            }
            // Display services as bullet list for cleaner reading
            const servicesEl = document.getElementById('summaryServices');
            if (services.length > 0) {
                servicesEl.innerHTML = services.map(s => `<div style="display: flex; gap: 6px; align-items: flex-start;"><span style="color: #16a34a;">â€¢</span> ${s}</div>`).join('');
            } else {
                servicesEl.textContent = 'â€”';
            }
            
            // Weed Man Services (separate section)
            const weedManLabels = {
                weed_control_fertilizer: 'Weed Control & Fertilizer',
                crabgrass_control: 'Crabgrass Control',
                insect_control: 'Insect Control',
                grub_control: 'Grub Control',
                mosquito_control: 'Mosquito Control',
                perimeter_pest: 'Perimeter Pest Control'
            };
            if (weedManServices && weedManServices.length > 0) {
                const weedLabels = weedManServices.map(s => weedManLabels[s] || s);
                // Display as bullet list for consistency
                document.getElementById('summaryWeedMan').innerHTML = weedLabels.map(s => `<div style="display: flex; gap: 6px; align-items: flex-start;"><span style="color: #16a34a;">â€¢</span> ${s}</div>`).join('');
                document.getElementById('weedManRow').style.display = 'block';
            } else {
                document.getElementById('weedManRow').style.display = 'none';
            }
            
            // Sqft
            document.getElementById('summarySqft').textContent = totalLawnSqft > 0 ? `${totalLawnSqft.toLocaleString()} sq ft` : 'Not measured';
            
            // Mulch
            if (totalMulchSqft > 0) {
                document.getElementById('mulchRow').style.display = 'flex';
                const cuFt = (totalMulchSqft * (mulchThickness / 12)).toFixed(1);
                const cuYards = (cuFt / 27).toFixed(2);
                document.getElementById('summaryMulch').textContent = `${totalMulchSqft.toLocaleString()} sq ft @ ${mulchThickness}" = ${cuFt} cu ft (${cuYards} yards)`;
            } else {
                document.getElementById('mulchRow').style.display = 'none';
            }
            
            // Gate
            if (hasGate) {
                document.getElementById('gateRow').style.display = 'flex';
                let gateText = gateWidth ? `${gateWidth}" wide` : 'Yes';
                const gateCodeValue = document.getElementById('gateCode').value;
                if (gateCodeValue) {
                    gateText += ` (Code: ${gateCodeValue})`;
                }
                document.getElementById('summaryGate').textContent = gateText;
            } else {
                document.getElementById('gateRow').style.display = 'none';
            }
            
            // Overgrown
            if (isOvergrown) {
                document.getElementById('overgrownRow').style.display = 'flex';
                const height = document.getElementById('grassHeight').value;
                document.getElementById('summaryOvergrown').textContent = height ? `Overgrown (~${height}")` : 'Overgrown';
            } else {
                document.getElementById('overgrownRow').style.display = 'none';
            }
            
            // Dogs
            if (hasDog !== null) {
                document.getElementById('dogsRow').style.display = 'flex';
                document.getElementById('summaryDogs').textContent = hasDog ? 'Yes' : 'No';
            } else {
                document.getElementById('dogsRow').style.display = 'none';
            }
            
            // Stairs
            if (hasStairs !== null) {
                document.getElementById('stairsRow').style.display = 'flex';
                document.getElementById('summaryStairs').textContent = hasStairs ? 'Yes' : 'No';
            } else {
                document.getElementById('stairsRow').style.display = 'none';
            }
            
            // Overgrown Disclaimer - show if mowing selected AND lawn NOT overgrown
            const hasMowing = selectedServices.mowing && (mowingType === 'weekly' || mowingType === 'biweekly' || mowingType === 'onetime');
            const showNoDisclaimer = hasMowing && isOvergrown === false;
            const showYesDisclaimer = hasMowing && isOvergrown === true;
            
            document.getElementById('overgrownDisclaimer').style.display = showNoDisclaimer ? 'block' : 'none';
            document.getElementById('overgrownYesDisclaimer').style.display = showYesDisclaimer ? 'block' : 'none';
        }
        
        // Map functions
        function initMap() {
            if (map) return;
            
            const address = document.getElementById('address').value;
            const geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({ address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const center = results[0].geometry.location;
                    createMap(center);
                } else {
                    // Default to Aurora, CO
                    createMap({ lat: 39.7294, lng: -104.8319 });
                }
            });
        }
        
        // Area tracking for individual management
        let areas = [];
        let lawnAreaCount = 0;
        let mulchAreaCount = 0;
        
        const areaColors = {
            lawn: [
                { fill: '#22c55e', stroke: '#16a34a', name: 'Section 1' },
                { fill: '#3b82f6', stroke: '#2563eb', name: 'Section 2' },
                { fill: '#06b6d4', stroke: '#0891b2', name: 'Section 3' },
                { fill: '#8b5cf6', stroke: '#7c3aed', name: 'Section 4' },
                { fill: '#ec4899', stroke: '#db2777', name: 'Section 5' },
            ],
            mulch: [
                { fill: '#ef4444', stroke: '#dc2626', name: 'Bed 1' },
                { fill: '#f97316', stroke: '#ea580c', name: 'Bed 2' },
                { fill: '#a855f7', stroke: '#9333ea', name: 'Bed 3' },
                { fill: '#14b8a6', stroke: '#0d9488', name: 'Bed 4' },
                { fill: '#f59e0b', stroke: '#d97706', name: 'Bed 5' },
            ],
            subtract: [
                { fill: '#ffffff', stroke: '#9ca3af', name: 'Subtracted' },
            ]
        };
        
        let subtractAreaCount = 0;
        
        // Store original map center for snapshot reset
        let originalMapCenter = null;
        
        // Small precision X cursor (12x12)
        const smallXCursor = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cline x1='0' y1='0' x2='12' y2='12' stroke='white' stroke-width='1.5'/%3E%3Cline x1='12' y1='0' x2='0' y2='12' stroke='white' stroke-width='1.5'/%3E%3Cline x1='0' y1='0' x2='12' y2='12' stroke='%23333' stroke-width='0.5'/%3E%3Cline x1='12' y1='0' x2='0' y2='12' stroke='%23333' stroke-width='0.5'/%3E%3C/svg%3E";
        
        function createMap(center) {
            // Store original center for snapshot reset
            originalMapCenter = center;
            
            map = new google.maps.Map(document.getElementById('map'), {
                center,
                zoom: 20,
                mapTypeId: 'satellite',
                tilt: 0,
                disableDefaultUI: true,
                zoomControl: true,
                gestureHandling: 'greedy',
                draggableCursor: `url(${smallXCursor}) 6 6, crosshair`,
                draggingCursor: `url(${smallXCursor}) 6 6, crosshair`
            });
            
            map.addListener('click', (e) => {
                // On mobile, our touch handlers manage point placement with precision mode
                // Skip the click handler to avoid double-placing points
                const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                if (isTouchDevice) {
                    // Deselect polygons but don't add points (touch handlers do that)
                    deselectAllPolygons();
                    return;
                }
                
                // Check if any polygon was editable before deselecting
                const wasEditing = areas.some(a => a.polygon && a.polygon.getEditable());
                
                // Deselect any editable polygons when clicking on the map
                deselectAllPolygons();
                
                // If we were editing, don't start a new polygon - just deselect
                if (wasEditing) return;
                
                addPoint(e.latLng);
            });
            updateUI();
            
            // Initialize magnifier for mobile
            initMagnifier();
        }
        
        // Mobile Precision Mode
        // The key UX insight: finger blocks the view, so we offset the placement point
        // ABOVE the finger position. The magnifier shows a zoomed view of that offset point.
        let magnifierActive = false;
        let magnifierTimeout = null;
        let pendingTouchLatLng = null;
        let precisionModeEnabled = false; // Track if we're in precision drawing mode
        
        // Offset distance: how far ABOVE the finger the placement point will be
        const PLACEMENT_OFFSET_Y = 80; // pixels above finger
        const MAGNIFIER_OFFSET_Y = 160; // magnifier bubble positioned even higher
        
        function initMagnifier() {
            const mapEl = document.getElementById('map');
            const magnifier = document.getElementById('magnifierBubble');
            const magnifierContent = document.getElementById('magnifierContent');
            const magnifierLine = document.getElementById('magnifierLine');
            const magnifierLabel = document.getElementById('magnifierLabel');
            const placementIndicator = document.getElementById('placementIndicator');
            const touchIndicator = document.getElementById('touchIndicator');
            
            // Check if device supports touch
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (!isTouchDevice) return;
            
            let touchStartTime = 0;
            let initialTouchX = 0;
            let initialTouchY = 0;
            let touchCount = 0;
            let mapWasDraggable = true; // Track original draggable state
            
            // Disable map dragging on single finger when precision mode is active
            // We'll re-enable it for two-finger gestures
            mapEl.addEventListener('touchstart', (e) => {
                touchCount = e.touches.length;
                
                // If two or more fingers, re-enable map dragging for pinch zoom/pan
                if (touchCount >= 2) {
                    if (map) map.setOptions({ draggable: true });
                    if (magnifierActive) {
                        hideMagnifier();
                    }
                    return;
                }
                
                // Single finger touch - DISABLE map dragging and enter precision mode
                if (map) {
                    mapWasDraggable = map.get('draggable') !== false;
                    map.setOptions({ draggable: false });
                }
                
                touchStartTime = Date.now();
                const touch = e.touches[0];
                initialTouchX = touch.clientX;
                initialTouchY = touch.clientY;
                
                // Prevent default to stop any remaining map panning
                e.preventDefault();
                e.stopPropagation();
                
                // Show magnifier after short delay (to allow quick taps)
                magnifierTimeout = setTimeout(() => {
                    showMagnifier(touch.clientX, touch.clientY);
                }, 80);
            }, { passive: false, capture: true }); // capture: true to get event before Google Maps
            
            mapEl.addEventListener('touchmove', (e) => {
                // If multiple fingers, let map handle it (pinch/zoom)
                if (e.touches.length >= 2) {
                    if (map) map.setOptions({ draggable: true });
                    if (magnifierActive) {
                        hideMagnifier();
                    }
                    return;
                }
                
                const touch = e.touches[0];
                
                // Prevent default to stop map panning
                e.preventDefault();
                e.stopPropagation();
                
                // If we've moved enough, activate magnifier if not already
                const moved = Math.abs(touch.clientX - initialTouchX) > 3 || 
                              Math.abs(touch.clientY - initialTouchY) > 3;
                
                if (moved && !magnifierActive) {
                    clearTimeout(magnifierTimeout);
                    showMagnifier(touch.clientX, touch.clientY);
                }
                
                if (magnifierActive) {
                    updateMagnifier(touch.clientX, touch.clientY);
                }
            }, { passive: false, capture: true });
            
            mapEl.addEventListener('touchend', (e) => {
                clearTimeout(magnifierTimeout);
                touchCount = e.touches.length;
                
                // If magnifier was active and we have a pending location, place the point
                if (magnifierActive && pendingTouchLatLng) {
                    const wasEditing = areas.some(a => a.polygon && a.polygon.getEditable());
                    deselectAllPolygons();
                    
                    if (!wasEditing) {
                        addPoint(pendingTouchLatLng);
                    }
                } else if (!magnifierActive) {
                    // Quick tap (no magnifier) - still place a point at the offset position
                    const holdDuration = Date.now() - touchStartTime;
                    if (holdDuration < 200) {
                        // Calculate the offset placement point for quick tap
                        const placementY = initialTouchY - PLACEMENT_OFFSET_Y;
                        const latLng = screenToLatLng(initialTouchX, placementY);
                        if (latLng) {
                            const wasEditing = areas.some(a => a.polygon && a.polygon.getEditable());
                            deselectAllPolygons();
                            if (!wasEditing) {
                                addPoint(latLng);
                            }
                        }
                    }
                }
                
                hideMagnifier();
                
                // Re-enable map dragging after touch ends
                if (map && mapWasDraggable) {
                    map.setOptions({ draggable: true });
                }
            }, { capture: true });
            
            mapEl.addEventListener('touchcancel', () => {
                clearTimeout(magnifierTimeout);
                hideMagnifier();
                // Re-enable map dragging
                if (map && mapWasDraggable) {
                    map.setOptions({ draggable: true });
                }
            }, { capture: true });
            
            // Static map clone for magnifier (no network requests!)
            let mapClone = null;
            let mapRect = null;
            const ZOOM_FACTOR = 2.5; // How much to zoom in the magnifier
            
            function captureMapSnapshot() {
                // Get the map container and its canvas
                const mapEl = document.getElementById('map');
                mapRect = mapEl.getBoundingClientRect();
                
                // Create or reuse the clone container
                if (!mapClone) {
                    mapClone = document.createElement('div');
                    mapClone.id = 'mapClone';
                    mapClone.style.cssText = `
                        position: absolute;
                        width: ${mapRect.width}px;
                        height: ${mapRect.height}px;
                        transform-origin: 0 0;
                        pointer-events: none;
                        will-change: transform;
                    `;
                    magnifierContent.appendChild(mapClone);
                }
                
                // Clone the visible map tiles (much faster than html2canvas)
                // Find all the tile images and canvas elements in the map
                const mapContainer = mapEl.querySelector('[aria-label="Map"]') || mapEl;
                mapClone.innerHTML = '';
                
                // Create a simple colored background matching satellite view
                mapClone.style.background = '#1a2e1a';
                
                // Get the actual rendered canvas from Google Maps
                const canvases = mapEl.querySelectorAll('canvas');
                canvases.forEach((canvas, i) => {
                    try {
                        const clonedCanvas = document.createElement('canvas');
                        clonedCanvas.width = canvas.width;
                        clonedCanvas.height = canvas.height;
                        clonedCanvas.style.cssText = canvas.style.cssText;
                        clonedCanvas.style.position = 'absolute';
                        const ctx = clonedCanvas.getContext('2d');
                        ctx.drawImage(canvas, 0, 0);
                        mapClone.appendChild(clonedCanvas);
                    } catch (e) {
                        // CORS may prevent canvas copying - that's ok
                    }
                });
                
                // Also grab any tile images
                const imgs = mapEl.querySelectorAll('img[src*="maps"]');
                imgs.forEach(img => {
                    if (img.complete && img.naturalWidth > 0) {
                        const clone = img.cloneNode(true);
                        clone.style.position = 'absolute';
                        // Copy computed position
                        const imgRect = img.getBoundingClientRect();
                        clone.style.left = (imgRect.left - mapRect.left) + 'px';
                        clone.style.top = (imgRect.top - mapRect.top) + 'px';
                        clone.style.width = imgRect.width + 'px';
                        clone.style.height = imgRect.height + 'px';
                        mapClone.appendChild(clone);
                    }
                });
                
                // === RENDER POLYGONS ONTO MAGNIFIER ===
                // Create a canvas overlay for drawing polygons
                const polygonCanvas = document.createElement('canvas');
                polygonCanvas.width = mapRect.width;
                polygonCanvas.height = mapRect.height;
                polygonCanvas.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: ${mapRect.width}px;
                    height: ${mapRect.height}px;
                    pointer-events: none;
                `;
                const ctx = polygonCanvas.getContext('2d');
                
                // Helper: convert lat/lng to screen coordinates relative to map
                function latLngToScreen(latLng) {
                    try {
                        const scale = Math.pow(2, map.getZoom());
                        const worldCoordinateCenter = map.getProjection().fromLatLngToPoint(map.getCenter());
                        const worldCoordinate = map.getProjection().fromLatLngToPoint(latLng);
                        const pixelOffset = new google.maps.Point(
                            (worldCoordinate.x - worldCoordinateCenter.x) * scale,
                            (worldCoordinate.y - worldCoordinateCenter.y) * scale
                        );
                        return {
                            x: mapRect.width / 2 + pixelOffset.x,
                            y: mapRect.height / 2 + pixelOffset.y
                        };
                    } catch (e) {
                        return null;
                    }
                }
                
                // Draw each polygon from areas array
                areas.forEach(area => {
                    if (!area.polygon) return;
                    
                    // Get all paths (main path + holes)
                    const paths = area.polygon.getPaths();
                    if (!paths || paths.getLength() === 0) return;
                    
                    // Get fill and stroke colors from polygon options
                    const fillColor = area.polygon.get('fillColor') || '#22c55e';
                    const fillOpacity = area.polygon.get('fillOpacity') || 0.3;
                    const strokeColor = area.polygon.get('strokeColor') || '#16a34a';
                    const strokeWidth = area.polygon.get('strokeWeight') || 3;
                    
                    ctx.beginPath();
                    
                    // Draw main path and any holes using evenodd fill rule
                    for (let pathIdx = 0; pathIdx < paths.getLength(); pathIdx++) {
                        const path = paths.getAt(pathIdx);
                        const pathArray = path.getArray();
                        if (pathArray.length < 3) continue;
                        
                        // Move to first point
                        const firstPoint = latLngToScreen(pathArray[0]);
                        if (!firstPoint) continue;
                        ctx.moveTo(firstPoint.x, firstPoint.y);
                        
                        // Line to remaining points
                        for (let i = 1; i < pathArray.length; i++) {
                            const point = latLngToScreen(pathArray[i]);
                            if (point) ctx.lineTo(point.x, point.y);
                        }
                        ctx.closePath();
                    }
                    
                    // Fill with semi-transparent color (evenodd for holes)
                    ctx.fillStyle = fillColor;
                    ctx.globalAlpha = fillOpacity;
                    ctx.fill('evenodd');
                    
                    // Stroke
                    ctx.globalAlpha = 1;
                    ctx.strokeStyle = strokeColor;
                    ctx.lineWidth = strokeWidth;
                    ctx.stroke();
                });
                
                // Also draw current drawing points (in-progress polygon)
                // Note: currentPoints contains LatLng objects, not Markers
                if (currentPoints.length > 0) {
                    ctx.beginPath();
                    const firstLatLng = currentPoints[0];
                    const firstPos = latLngToScreen(firstLatLng);
                    if (firstPos) {
                        ctx.moveTo(firstPos.x, firstPos.y);
                        for (let i = 1; i < currentPoints.length; i++) {
                            const pos = latLngToScreen(currentPoints[i]);
                            if (pos) ctx.lineTo(pos.x, pos.y);
                        }
                    }
                    // Draw line but don't fill (it's not closed yet)
                    const modeColors = drawMode === 'lawn' ? areaColors.lawn[0] : 
                                       drawMode === 'mulch' ? areaColors.mulch[0] : 
                                       areaColors.subtract[0];
                    ctx.strokeStyle = modeColors.stroke;
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                    
                    // Draw dots at each point
                    currentPoints.forEach((latLng, i) => {
                        const pos = latLngToScreen(latLng);
                        if (pos) {
                            ctx.beginPath();
                            ctx.arc(pos.x, pos.y, i === 0 ? 4 : 3, 0, Math.PI * 2);
                            ctx.fillStyle = i === 0 ? modeColors.fill : '#ffffff';
                            ctx.fill();
                            ctx.strokeStyle = modeColors.stroke;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    });
                }
                
                mapClone.appendChild(polygonCanvas);
            }
            
            function showMagnifier(fingerX, fingerY) {
                magnifierActive = true;
                precisionModeEnabled = true;
                
                // Capture static map snapshot once on show (no network calls!)
                captureMapSnapshot();
                
                magnifier.classList.add('active');
                magnifierLine.classList.add('active');
                magnifierLabel.classList.add('active');
                placementIndicator.classList.add('active');
                touchIndicator.classList.add('active');
                
                updateMagnifier(fingerX, fingerY);
            }
            
            function updateMagnifier(fingerX, fingerY) {
                if (!magnifierActive || !map) return;
                
                // Calculate the OFFSET placement point (above finger)
                const placementX = fingerX;
                const placementY = fingerY - PLACEMENT_OFFSET_Y;
                
                // Magnifier position (even higher above)
                const magnifierX = fingerX;
                const magnifierY = fingerY - MAGNIFIER_OFFSET_Y;
                
                // === PURE CSS POSITIONING - 60fps smooth ===
                
                // Touch indicator at finger
                touchIndicator.style.left = fingerX + 'px';
                touchIndicator.style.top = fingerY + 'px';
                
                // Placement indicator where point lands
                placementIndicator.style.left = placementX + 'px';
                placementIndicator.style.top = placementY + 'px';
                
                // Magnifier bubble (high above)
                magnifier.style.left = magnifierX + 'px';
                magnifier.style.top = magnifierY + 'px';
                
                // Connecting line from magnifier to placement point
                const bubbleRadius = 50; // 100px bubble / 2
                const lineTop = magnifierY + bubbleRadius;
                const lineHeight = Math.max(0, placementY - lineTop - 12); // 12px gap at bottom
                magnifierLine.style.left = fingerX + 'px';
                magnifierLine.style.top = lineTop + 'px';
                magnifierLine.style.height = lineHeight + 'px';
                magnifierLine.style.transform = 'translateX(-50%)';
                
                // Label above magnifier
                magnifierLabel.style.left = fingerX + 'px';
                magnifierLabel.style.top = (magnifierY - 60) + 'px';
                magnifierLabel.style.transform = 'translateX(-50%)';
                
                // Calculate lat/lng for the placement position
                pendingTouchLatLng = screenToLatLng(placementX, placementY);
                
                // === CSS TRANSFORM THE STATIC SNAPSHOT (no network!) ===
                if (mapClone && mapRect) {
                    // Show what's under the PLACEMENT POINT (the pin), not the finger
                    // User needs to see where the pin will land, not what they're touching
                    const mapX = placementX - mapRect.left;
                    const mapY = placementY - mapRect.top;
                    
                    // The magnifier content area is 120x120, we want to show zoomed area
                    // Calculate offset to center the finger position in the magnifier
                    const magnifierSize = 120;
                    const cloneOffsetX = (magnifierSize / 2) - (mapX * ZOOM_FACTOR);
                    const cloneOffsetY = (magnifierSize / 2) - (mapY * ZOOM_FACTOR);
                    
                    // Apply GPU-accelerated transform (scale + translate)
                    mapClone.style.transform = `translate(${cloneOffsetX}px, ${cloneOffsetY}px) scale(${ZOOM_FACTOR})`;
                }
            }
            
            function screenToLatLng(screenX, screenY) {
                try {
                    const mapDiv = document.getElementById('map');
                    const rect = mapDiv.getBoundingClientRect();
                    const mapX = screenX - rect.left;
                    const mapY = screenY - rect.top;
                    
                    // Clamp to map bounds
                    const clampedX = Math.max(0, Math.min(rect.width, mapX));
                    const clampedY = Math.max(0, Math.min(rect.height, mapY));
                    
                    // Convert pixel to lat/lng using Google Maps projection
                    const scale = Math.pow(2, map.getZoom());
                    const worldCoordinateCenter = map.getProjection().fromLatLngToPoint(map.getCenter());
                    const pixelOffset = new google.maps.Point(
                        (clampedX - rect.width / 2) / scale,
                        (clampedY - rect.height / 2) / scale
                    );
                    const worldCoordinate = new google.maps.Point(
                        worldCoordinateCenter.x + pixelOffset.x,
                        worldCoordinateCenter.y + pixelOffset.y
                    );
                    return map.getProjection().fromPointToLatLng(worldCoordinate);
                } catch (e) {
                    console.warn('Projection not ready:', e);
                    return null;
                }
            }
            
            function hideMagnifier() {
                magnifierActive = false;
                precisionModeEnabled = false;
                
                magnifier.classList.remove('active');
                magnifierLine.classList.remove('active');
                magnifierLabel.classList.remove('active');
                placementIndicator.classList.remove('active');
                touchIndicator.classList.remove('active');
                
                pendingTouchLatLng = null;
            }
        }
        
        // Deselect all polygons (turn off editing)
        function deselectAllPolygons() {
            areas.forEach(a => {
                if (a.polygon) a.polygon.setEditable(false);
            });
        }
        
        function setDrawMode(mode) {
            // Don't auto-finish, just clear current drawing and switch modes
            deselectAllPolygons();
            clearDrawingState();
            drawMode = mode;
            document.getElementById('btnLawn').classList.toggle('active', mode === 'lawn');
            document.getElementById('btnMulch').classList.toggle('active', mode === 'mulch');
            document.getElementById('btnSubtract').classList.toggle('active', mode === 'subtract');
            
            // CRITICAL: In subtract mode, make ALL polygons non-clickable so clicks pass through to the map
            // This lets users click INSIDE drawn areas to draw subtract shapes
            areas.forEach(a => {
                if (a.polygon) {
                    a.polygon.setOptions({ clickable: mode !== 'subtract' });
                }
            });
            
            currentPoints = [];
            updateUI();
        }
        
        function toggleHelpMenu() {
            const menu = document.getElementById('helpMenu');
            menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
        }
        
        function addPoint(latLng) {
            // PREVENT drawing inside existing polygons (unless in subtract mode)
            // This stops users from accidentally starting a new lawn/mulch inside an existing one
            if (drawMode !== 'subtract') {
                const existingAreas = areas.filter(a => (a.type === 'lawn' || a.type === 'mulch') && a.polygon);
                for (const area of existingAreas) {
                    if (google.maps.geometry.poly.containsLocation(latLng, area.polygon)) {
                        console.log('âš ï¸ Blocked: Cannot draw inside existing ' + area.type + ' polygon. Use Subtract mode to cut holes.');
                        // Don't add the point - silently ignore
                        return;
                    }
                }
            }
            
            // Check if clicking near first point to close polygon (when 3+ points)
            // Reduced to 0.5 meters to prevent accidental closes
            if (currentPoints.length >= 3) {
                const firstPoint = currentPoints[0];
                const distance = google.maps.geometry.spherical.computeDistanceBetween(latLng, firstPoint);
                // If within 0.5 meters of first point, close the polygon
                if (distance < 0.5) {
                    finishPolygon();
                    return;
                }
            }
            
            currentPoints.push(latLng);
            
            const colors = areaColors[drawMode];
            const count = drawMode === 'lawn' ? lawnAreaCount : (drawMode === 'mulch' ? mulchAreaCount : subtractAreaCount);
            const colorSet = colors[count % colors.length];
            const isFirst = currentPoints.length === 1;
            
            // Smaller markers for precision
            const marker = new google.maps.Marker({
                position: latLng,
                map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: isFirst ? 3 : 2,
                    fillColor: isFirst ? colorSet.fill : '#ffffff',
                    fillOpacity: 1,
                    strokeColor: colorSet.stroke,
                    strokeWeight: 0.5
                }
            });
            
            // First marker is clickable to close polygon
            if (isFirst) {
                marker.addListener('click', () => {
                    if (currentPoints.length >= 3) finishPolygon();
                });
            }
            
            markers.push(marker);
            
            if (currentPolyline) {
                currentPolyline.setPath(currentPoints);
            } else {
                currentPolyline = new google.maps.Polyline({
                    path: currentPoints,
                    strokeColor: colorSet.stroke,
                    strokeOpacity: 1,
                    strokeWeight: 1,
                    map
                });
            }
            
            updateUI();
        }
        
        function finishPolygon() {
            deselectAllPolygons();
            if (currentPoints.length < 3) {
                clearDrawingState();
                currentPoints = [];
                updateUI();
                return;
            }
            
            const colors = areaColors[drawMode];
            const count = drawMode === 'lawn' ? lawnAreaCount : (drawMode === 'mulch' ? mulchAreaCount : subtractAreaCount);
            const colorSet = colors[count % colors.length];
            
            // For subtract mode, cut a hole in the existing lawn OR mulch polygon (cookie-cutter style)
            if (drawMode === 'subtract') {
                console.log('ðŸ” Subtract mode - checking for parent area (lawn or mulch)');
                // Find lawn AND mulch polygons and check which one contains this subtraction
                const parentAreas = areas.filter(a => a.type === 'lawn' || a.type === 'mulch');
                console.log('Found', parentAreas.length, 'drawable areas (lawn + mulch)');
                let parentLawn = null;
                
                // Check if ANY point of subtraction is inside any drawable polygon (more forgiving)
                for (const parentArea of parentAreas) {
                    // Check multiple points to be more forgiving
                    for (const point of currentPoints) {
                        const contains = google.maps.geometry.poly.containsLocation(point, parentArea.polygon);
                        if (contains) {
                            parentLawn = parentArea;
                            console.log('âœ… Found parent area containing point:', parentArea.name, '(type:', parentArea.type + ')');
                            break;
                        }
                    }
                    if (parentLawn) break;
                }
                
                if (!parentLawn && parentAreas.length > 0) {
                    // Fallback: just use the first drawable area if we have one
                    console.log('âš ï¸ No containment found, using first area as parent');
                    parentLawn = parentAreas[0];
                }
                
                if (!parentLawn) {
                    console.log('âŒ No drawable areas exist - cannot subtract');
                    alert('Please draw a lawn area or mulch bed first, then use subtract to cut out pools, patios, etc.');
                    clearDrawingState();
                    currentPoints = [];
                    return;
                }
                
                console.log('âœ… Using parent area:', parentLawn.name, '(type:', parentLawn.type + ')');
                
                // Calculate winding order using shoelace formula
                // Returns positive for counter-clockwise, negative for clockwise
                function getSignedArea(points) {
                    let area = 0;
                    const n = points.length;
                    for (let i = 0; i < n; i++) {
                        const j = (i + 1) % n;
                        const p1 = points[i];
                        const p2 = points[j];
                        // Use lat/lng (treating as x/y for 2D calculation)
                        area += (p2.lng() - p1.lng()) * (p2.lat() + p1.lat());
                    }
                    return area / 2;
                }
                
                // Get the outer path's winding order
                const outerPath = parentLawn.polygon.getPath().getArray();
                const outerSignedArea = getSignedArea(outerPath);
                const holeSignedArea = getSignedArea(currentPoints);
                
                console.log('Outer signed area:', outerSignedArea, outerSignedArea > 0 ? '(CW)' : '(CCW)');
                console.log('Hole signed area:', holeSignedArea, holeSignedArea > 0 ? '(CW)' : '(CCW)');
                
                // For Google Maps polygon holes:
                // - Outer path and hole must have OPPOSITE winding directions
                // - If both are same direction (same sign), reverse the hole
                let holePath;
                if ((outerSignedArea > 0 && holeSignedArea > 0) || (outerSignedArea < 0 && holeSignedArea < 0)) {
                    // Same winding direction - reverse the hole to make opposite
                    holePath = [...currentPoints].reverse();
                    console.log('ðŸ”„ Reversed hole path for correct winding');
                } else {
                    // Already opposite winding - use as-is
                    holePath = [...currentPoints];
                    console.log('âœ… Hole already has correct winding');
                }
                
                // Store the hole index for this subtract area
                const holeIndex = parentLawn.polygon.getPaths().getLength();
                
                // Get current paths from the lawn polygon
                const currentPaths = parentLawn.polygon.getPaths();
                const pathsArray = [];
                for (let i = 0; i < currentPaths.getLength(); i++) {
                    pathsArray.push(currentPaths.getAt(i).getArray());
                }
                console.log('Current paths count:', pathsArray.length);
                
                // Add the hole path
                pathsArray.push(holePath);
                console.log('New paths count (with hole):', pathsArray.length);
                
                // Update the lawn polygon with the new paths including the hole
                parentLawn.polygon.setPaths(pathsArray);
                console.log('âœ… setPaths called with', pathsArray.length, 'paths - hole should now be visible');
                
                // Calculate subtraction area
                const areaMeters = google.maps.geometry.spherical.computeArea(currentPoints);
                const sqft = Math.round(areaMeters * 10.764);
                
                // Store subtraction info (no separate polygon, just data for the hole)
                const area = {
                    polygon: null, // No separate polygon - it's a hole cut into the lawn
                    sqft,
                    color: colorSet.fill,
                    name: colorSet.name,
                    type: 'subtract',
                    parentLawnIndex: areas.indexOf(parentLawn),
                    holeIndex: holeIndex, // Track which hole this is in the parent polygon
                    holePath: holePath
                };
                areas.push(area);
                subtractAreaCount++;
                
                calculateTotalAreas();
                clearDrawingState();
                currentPoints = [];
                updateUI();
                return;
            }
            
            // Use array of arrays for paths to support holes later
            const polygon = new google.maps.Polygon({
                paths: [currentPoints],
                strokeColor: colorSet.stroke,
                strokeOpacity: 1,
                strokeWeight: drawMode === 'subtract' ? 1 : 0.75,
                fillColor: colorSet.fill,
                fillOpacity: drawMode === 'subtract' ? 0.5 : 0.35,
                editable: false,
                clickable: true,
                map
            });
            
            // Double-click to edit
            polygon.addListener('dblclick', () => {
                areas.forEach(a => { if (a.polygon) a.polygon.setEditable(false); });
                polygon.setEditable(true);
            });
            
            const areaMeters = google.maps.geometry.spherical.computeArea(polygon.getPath());
            const sqft = Math.round(areaMeters * 10.764);
            
            const area = { 
                polygon, 
                sqft, 
                color: colorSet.fill, 
                name: colorSet.name, 
                type: drawMode 
            };
            areas.push(area);
            
            // Update sqft when polygon is edited
            google.maps.event.addListener(polygon.getPath(), 'set_at', () => {
                area.sqft = Math.round(google.maps.geometry.spherical.computeArea(polygon.getPath()) * 10.764);
                calculateTotalAreas();
            });
            google.maps.event.addListener(polygon.getPath(), 'insert_at', () => {
                area.sqft = Math.round(google.maps.geometry.spherical.computeArea(polygon.getPath()) * 10.764);
                calculateTotalAreas();
            });
            
            if (drawMode === 'lawn') {
                lawnAreaCount++;
            } else if (drawMode === 'mulch') {
                mulchAreaCount++;
            } else if (drawMode === 'subtract') {
                subtractAreaCount++;
            }
            
            calculateTotalAreas();
            
            // Reset for next polygon
            clearDrawingState();
            currentPoints = [];
            updateUI();
        }
        
        function clearDrawingState() {
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }
            markers.forEach(m => m.setMap(null));
            markers = [];
        }
        
        function removeArea(index) {
            if (index >= 0 && index < areas.length) {
                const area = areas[index];
                
                // If this is a subtract hole (no polygon, has parent area - lawn or mulch)
                if (area.type === 'subtract' && area.polygon === null && area.parentLawnIndex !== undefined) {
                    // Find the parent area and rebuild its paths without this hole
                    const parentArea = areas[area.parentLawnIndex];
                    if (parentArea && parentArea.polygon) {
                        const currentPaths = parentArea.polygon.getPaths();
                        const newPaths = [];
                        
                        // Keep only the outer path (first one)
                        newPaths.push(currentPaths.getAt(0).getArray());
                        
                        // Re-add all OTHER subtract holes for this parent (excluding the one being removed)
                        areas.forEach((a, i) => {
                            if (i !== index && a.type === 'subtract' && a.parentLawnIndex === area.parentLawnIndex && a.holePath) {
                                newPaths.push(a.holePath);
                            }
                        });
                        
                        parentArea.polygon.setPaths(newPaths);
                        console.log('ðŸ”„ Rebuilt', parentArea.type, 'polygon with', newPaths.length - 1, 'holes');
                    }
                } else if ((area.type === 'lawn' || area.type === 'mulch') && area.polygon) {
                    // Removing a lawn or mulch area - also remove all its subtract holes from the areas array
                    const parentIndex = index;
                    area.polygon.setMap(null);
                    
                    // Mark subtract areas that belong to this parent for removal
                    const subtractsToRemove = [];
                    areas.forEach((a, i) => {
                        if (a.type === 'subtract' && a.parentLawnIndex === parentIndex) {
                            subtractsToRemove.push(i);
                        }
                    });
                    
                    // Remove subtract areas in reverse order to maintain correct indices
                    subtractsToRemove.sort((a, b) => b - a);
                    subtractsToRemove.forEach(i => {
                        if (i !== index) { // Don't double-remove if somehow this was a subtract
                            areas.splice(i, 1);
                        }
                    });
                } else if (area.polygon) {
                    area.polygon.setMap(null);
                }
                
                // Now remove the main area
                areas.splice(index, 1);
                
                // Update parentLawnIndex references for remaining subtract areas
                areas.forEach(a => {
                    if (a.type === 'subtract' && a.parentLawnIndex !== undefined) {
                        if (a.parentLawnIndex > index) {
                            a.parentLawnIndex--;
                        }
                    }
                });
                
                calculateTotalAreas();
                updateUI();
            }
        }
        
        function calculateTotalAreas() {
            const lawnAreas = areas.filter(a => a.type === 'lawn');
            const mulchAreas = areas.filter(a => a.type === 'mulch');
            const subtractAreas = areas.filter(a => a.type === 'subtract');
            
            // Calculate subtract amounts per parent type
            let lawnSubtractSqft = 0;
            let mulchSubtractSqft = 0;
            
            subtractAreas.forEach(subArea => {
                if (subArea.parentLawnIndex !== undefined) {
                    const parent = areas[subArea.parentLawnIndex];
                    if (parent) {
                        if (parent.type === 'lawn') {
                            lawnSubtractSqft += subArea.sqft;
                        } else if (parent.type === 'mulch') {
                            mulchSubtractSqft += subArea.sqft;
                        }
                    }
                }
            });
            
            totalLawnSqft = Math.max(0, lawnAreas.reduce((sum, a) => sum + a.sqft, 0) - lawnSubtractSqft);
            totalMulchSqft = Math.max(0, mulchAreas.reduce((sum, a) => sum + a.sqft, 0) - mulchSubtractSqft);
            updateMapResult();
        }
        
        function updateMapResult() {
            const result = document.getElementById('mapResult');
            const areaList = document.getElementById('areaList');
            const mulchCalculator = document.getElementById('mulchCalculator');
            
            if (totalLawnSqft > 0 || totalMulchSqft > 0) {
                result.style.display = 'block';
                
                // Update total display
                let displayText = '';
                if (totalLawnSqft > 0 && totalMulchSqft > 0) {
                    displayText = `${totalLawnSqft.toLocaleString()} + ${totalMulchSqft.toLocaleString()} sq ft`;
                } else if (totalMulchSqft > 0) {
                    displayText = `${totalMulchSqft.toLocaleString()} sq ft`;
                } else {
                    displayText = `${totalLawnSqft.toLocaleString()} sq ft`;
                }
                document.getElementById('totalSqft').textContent = displayText;
                
                // Update area chips
                if (areaList) {
                    areaList.innerHTML = areas.map((a, i) => {
                        if (a.type === 'subtract') {
                            // Subtract areas: show sqft being subtracted with white/gray styling
                            return `
                                <div class="area-chip" style="border-color: #d1d5db; background: #f9fafb;">
                                    <span class="area-chip-dot" style="background: #ffffff; border: 1px solid #9ca3af;"></span>
                                    <span class="area-chip-name">âˆ’ ${a.name}</span>
                                    <span class="area-chip-sqft" style="color: #6b7280;">âˆ’${a.sqft.toLocaleString()} sq ft</span>
                                    <button class="area-chip-remove" onclick="removeArea(${i})">Ã—</button>
                                </div>
                            `;
                        } else {
                            // Lawn/Mulch areas: show full details with sqft
                            return `
                                <div class="area-chip">
                                    <span class="area-chip-dot" style="background: ${a.color}"></span>
                                    <span class="area-chip-name">${a.name}</span>
                                    <span class="area-chip-sqft">${a.sqft.toLocaleString()} sq ft</span>
                                    <button class="area-chip-remove" onclick="removeArea(${i})">Ã—</button>
                                </div>
                            `;
                        }
                    }).join('');
                }
                
                // Show/hide and update mulch calculator
                if (mulchCalculator) {
                    if (totalMulchSqft > 0) {
                        mulchCalculator.style.display = 'block';
                        updateMulchCalculator();
                    } else {
                        mulchCalculator.style.display = 'none';
                    }
                }
            } else {
                result.style.display = 'none';
                if (mulchCalculator) {
                    mulchCalculator.style.display = 'none';
                }
            }
            
            // Update mulch indicator
            updateMulchIndicator();
        }
        
        function setMulchThickness(inches) {
            mulchThickness = inches;
            // Update button states
            document.querySelectorAll('.thickness-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.inches) === inches);
            });
            updateMulchCalculator();
        }
        
        function updateMulchCalculator() {
            // Update sqft display
            document.getElementById('mulchSqftDisplay').textContent = totalMulchSqft.toLocaleString() + ' sq ft';
            
            // Calculate cubic feet: sqft * (thickness in feet)
            // thickness is in inches, so divide by 12 to get feet
            const cubicFeet = totalMulchSqft * (mulchThickness / 12);
            document.getElementById('mulchCuFt').textContent = cubicFeet.toFixed(1);
            
            // Calculate cubic yards (27 cubic feet per cubic yard)
            const cubicYards = cubicFeet / 27;
            document.getElementById('mulchYards').textContent = cubicYards.toFixed(2);
        }
        
        function updateUI() {
            const pointCount = currentPoints.length;
            const hasAreas = areas.length > 0;
            const isDrawing = pointCount > 0;
            
            // Point counter badge
            const counter = document.getElementById('pointCounter');
            if (counter) {
                if (pointCount > 0) {
                    counter.style.display = 'block';
                    counter.className = pointCount >= 3 ? 'point-badge ready' : 'point-badge';
                    counter.textContent = pointCount >= 3 ? `${pointCount} pts â€” tap first to close` : `${pointCount} / 3 points`;
                } else {
                    counter.style.display = 'none';
                }
            }
            
            // Finish button
            const finishBtn = document.getElementById('finishBtn');
            if (finishBtn) {
                finishBtn.style.display = pointCount >= 3 ? 'inline-flex' : 'none';
            }
            
            // Clear button
            const clearBtn = document.getElementById('clearAllBtn');
            if (clearBtn) {
                clearBtn.style.display = (hasAreas || pointCount > 0) ? 'inline-flex' : 'none';
            }
            
            // Update instructions
            const instructions = document.querySelector('.map-instructions');
            if (instructions) {
                if (isDrawing && pointCount >= 3) {
                    instructions.innerHTML = '<strong>Tap the first point</strong> or click Done to complete the shape';
                } else if (isDrawing && pointCount > 0) {
                    instructions.innerHTML = `<strong>${3 - pointCount} more point${3 - pointCount !== 1 ? 's' : ''}</strong> needed to complete the shape`;
                } else if (drawMode === 'subtract') {
                    instructions.innerHTML = '<strong>Draw area to subtract</strong> â€” Outline pools, patios, gardens, or other areas to cut out';
                } else if (hasAreas) {
                    instructions.innerHTML = `Draw another <strong>${drawMode === 'mulch' ? 'mulch bed' : 'lawn area'}</strong> or continue to review`;
                } else {
                    instructions.innerHTML = '<strong>Outline your lawn area</strong> â€” Tap points around your lawn to measure square footage';
                }
            }
        }
        
        function undoLastPoint() {
            deselectAllPolygons();
            if (currentPoints.length > 0) {
                currentPoints.pop();
                if (currentPolyline) {
                    currentPolyline.setPath(currentPoints);
                }
                if (markers.length > 0) {
                    const m = markers.pop();
                    m.setMap(null);
                }
                updateUI();
            }
        }
        
        function clearAllAreas() {
            deselectAllPolygons();
            areas.forEach(a => a.polygon && a.polygon.setMap(null));
            areas = [];
            lawnAreaCount = 0;
            mulchAreaCount = 0;
            subtractAreaCount = 0;
            lawnPolygons = [];
            mulchPolygons = [];
            totalLawnSqft = 0;
            totalMulchSqft = 0;
            currentPoints = [];
            clearDrawingState();
            updateMapResult();
            updateUI();
        }
        
        // Submit quote
        async function submitQuote() {
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Collect all data
                const data = {
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    referralSource: document.getElementById('referralSource').value,
                    smsConsent: document.getElementById('smsConsent').checked,
                    selectedPackage: selectedPackage, // 'essential', 'complete', 'total', or null (custom)
                    packageWasEdited: selectedPackage ? packageWasEdited : false, // True if user modified services after selecting a package
                    services: selectedServices,
                    mowingType: mowingType,
                    fertilizationType: fertilizationType,
                    weedManServices: weedManServices,
                    weedManPayment: weedManServices.length > 0 ? (document.querySelector('input[name="weedManPayment"]:checked')?.value || 'per_service') : null,
                    mulchColor: mulchColor,
                    bushTrimmingFrequency: bushTrimmingFrequency,
                    hasGate: hasGate,
                    gateWidth: gateWidth,
                    gateCode: hasGate ? (document.getElementById('gateCode').value || null) : null,
                    hasDog: hasDog,
                    dogConfirmed: dogConfirmed,
                    isOvergrown: isOvergrown,
                    overgrownAcknowledged: document.getElementById('overgrownDisclaimer').style.display !== 'none',
                    grassHeight: isOvergrown ? document.getElementById('grassHeight').value : null,
                    hasStairs: hasStairs,
                    notes: [document.getElementById('notes').value.trim(), document.getElementById('customerNotes').value.trim()].filter(n => n).join(' | '),
                    propertyNotes: document.getElementById('notes').value.trim() || null, // Page 1 notes
                    additionalNotes: document.getElementById('customerNotes').value.trim() || null, // Page 3 notes
                    lawnSqft: totalLawnSqft,
                    mulchSqft: totalMulchSqft,
                    mulchThickness: totalMulchSqft > 0 ? mulchThickness : null,
                    mulchCuFt: totalMulchSqft > 0 ? (totalMulchSqft * (mulchThickness / 12)).toFixed(1) : null,
                    mulchCuYards: totalMulchSqft > 0 ? ((totalMulchSqft * (mulchThickness / 12)) / 27).toFixed(2) : null,
                    photos: photos.map(p => p.data),
                    submissionConfirmed: true, // Always true since they passed validation to get here
                    timestamp: new Date().toISOString()
                };
                
                // Capture map screenshot if available
                if (map && (totalLawnSqft > 0 || totalMulchSqft > 0)) {
                    try {
                        // Store map center/zoom data
                        data.mapCenter = {
                            lat: map.getCenter().lat(),
                            lng: map.getCenter().lng()
                        };
                        data.mapZoom = map.getZoom();
                        
                        // Extract polygon coordinates for each area
                        data.polygons = areas.map(area => {
                            let coords = [];
                            if (area.polygon) {
                                const path = area.polygon.getPath();
                                for (let i = 0; i < path.getLength(); i++) {
                                    const point = path.getAt(i);
                                    coords.push({ lat: point.lat(), lng: point.lng() });
                                }
                            } else if (area.holePath) {
                                // Subtract areas store path in holePath
                                coords = area.holePath.map(point => ({ lat: point.lat(), lng: point.lng() }));
                            }
                            return {
                                type: area.type,
                                sqft: area.sqft,
                                coords: coords
                            };
                        });
                        
                        // Reset map to default view (original center + good zoom) for clean snapshot
                        // This ensures snapshot always shows the property nicely centered,
                        // regardless of how much the customer panned/zoomed during measurement
                        if (originalMapCenter) {
                            map.setCenter(originalMapCenter);
                        }
                        map.setZoom(19); // Good zoom level to show property + drawn areas
                        
                        // Wait for map tiles to load after resetting view
                        await new Promise(r => setTimeout(r, 800));
                        
                        // Capture map container as image
                        const mapContainer = document.getElementById('map');
                        if (mapContainer && typeof html2canvas !== 'undefined') {
                            const canvas = await html2canvas(mapContainer, {
                                useCORS: true,
                                allowTaint: true,
                                backgroundColor: '#ffffff'
                            });
                            data.snapshot = canvas.toDataURL('image/png');
                            console.log('Map snapshot captured at default view');
                        }
                    } catch (e) {
                        console.warn('Failed to capture map snapshot:', e);
                    }
                }
                
                const response = await fetch('/api/quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showScreen('screenSuccess');
                } else {
                    throw new Error('Failed to submit');
                }
            } catch (err) {
                alert('Sorry, there was an error submitting your request. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Quote Request';
            }
        }
        
        // ========================================
        // IFRAME AUTO-HEIGHT (no double-scrolling)
        // ========================================
        (function() {
            function sendHeight() {
                const height = document.body.scrollHeight;
                window.parent.postMessage({ type: 'nmw-widget-height', height: height }, '*');
            }
            
            // Send on load
            window.addEventListener('load', () => {
                sendHeight();
                // Send again after fonts load
                setTimeout(sendHeight, 100);
                setTimeout(sendHeight, 500);
            });
            
            // Watch for content changes
            const observer = new ResizeObserver(() => sendHeight());
            observer.observe(document.body);
            
            // Also send on any screen change
            const originalShowScreen = window.showScreen;
            if (originalShowScreen) {
                window.showScreen = function(id) {
                    originalShowScreen(id);
                    setTimeout(sendHeight, 50);
                    setTimeout(sendHeight, 200);
                };
            }
            
            // ========================================
            // LISTEN FOR PARENT PAGE MESSAGES
            // ========================================
            window.addEventListener('message', function(event) {
                // Handle parent page resize notification
                if (event.data && event.data.type === 'pageResize') {
                    console.log('ðŸ“¨ Parent page resized:', event.data.pageHeight || 'height not provided');
                    // Re-send our height to confirm sync
                    sendHeight();
                }
                
                // Handle parent requesting height update
                if (event.data && event.data.type === 'requestHeight') {
                    sendHeight();
                }
                
                // Log for debugging
                if (event.data && event.data.type) {
                    console.log('Widget received message:', event.data.type);
                }
            });
        })();
    </script>
</body>
</html>
